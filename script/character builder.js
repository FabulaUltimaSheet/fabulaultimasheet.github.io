"use strict";var characterInfo=null,keptPressed=!1,waitForCallback=!1,clockList=[],FUDB={},fullData={},data={},currentLanguage="ITA";const domain="https://com.studiosplinters.fabulaultimabeyond/",fallbackImgB64="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAACXBIWXMAABESAAAREgEAwpvaAAACCklEQVQokbWSO2hUURiE5//vuY/NzVNXYohuCCoJKVSMIIqNYrqIkEJIo5WKjYJgIYjGQstUgihiaSpBCIKNEFFQEDEGNObhc03MWza7yZ6995zzWwSCYJXC6QZmmvmGRAQbEW8oDUABSEQcwIAABDCgiCoQASKQMykrvwLxQQSoca2vmjIgDeIYNEu0VeiUCvrJVAn64EfPHuLoyT64OfZ2WKeU8kbCegADupwLMidIlsTtJBoW3pQm2535/nMyZ11rGA+xd1i0ipUHB+coDtVmpkcgD0zixCCFL8ligzfHSEJbbYRbPcWNQO71Mr9xtRbzJVOTuCwAEL2z3gdbGuzD8kTpyY3Pec3vbb32lBNeHJpcTYMjz3k1cTURj1zugJXKyy+l2jA+fn5h8MyWrnNteXn84tu2thYlItMTY9pI2L67d1/D2UNZJgqY0uWS0WVUZ6ua6ry40Vspu9mZSHKqktrEis/m1aWObMZbG9tZ66bGNbPhrrilmfw4XZ12C/nI28++4kxgHEFg1+nEvhdWLTVm08APKNMMUF2NMaEuVjSnIoXfb9N0dDT/62+cV3o6v858ajp97f7H9u6bDy723ysWx77Oz9NUodB76+7Ej9ko8IfvXK/NROu1pyOjF24PALSidfeBPcf27uo52EkiIiLGusJKOVtX/e95imXNRHEUrln672/9A3Ga9XsyeQGMAAAAAElFTkSuQmCC",systemData={svg:{bars:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>',bolt:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M296 160H180.6l42.6-129.8C227.2 15 215.7 0 200 0H56C44 0 33.8 8.9 32.2 20.8l-32 240C-1.7 275.2 9.5 288 24 288h118.7L96.6 482.5c-3.6 15.2 8 29.5 23.3 29.5 8.4 0 16.4-4.4 20.8-12l176-304c9.3-15.9-2.2-36-20.7-36z"/></svg>',coins:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 405.3V448c0 35.3 86 64 192 64s192-28.7 192-64v-42.7C342.7 434.4 267.2 448 192 448S41.3 434.4 0 405.3zM320 128c106 0 192-28.7 192-64S426 0 320 0 128 28.7 128 64s86 64 192 64zM0 300.4V352c0 35.3 86 64 192 64s192-28.7 192-64v-51.6c-41.3 34-116.9 51.6-192 51.6S41.3 334.4 0 300.4zm416 11c57.3-11.1 96-31.7 96-55.4v-42.7c-23.2 16.4-57.3 27.6-96 34.5v63.6zM192 160C86 160 0 195.8 0 240s86 80 192 80 192-35.8 192-80-86-80-192-80zm219.3 56.3c60-10.8 100.7-32 100.7-56.3v-42.7c-35.5 25.1-96.5 38.6-160.7 41.8 29.5 14.3 51.2 33.5 60 57.2z"/></svg>',bone:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M598.88 244.56c25.2-12.6 41.12-38.36 41.12-66.53v-7.64C640 129.3 606.7 96 565.61 96c-32.02 0-60.44 20.49-70.57 50.86-7.68 23.03-11.6 45.14-38.11 45.14H183.06c-27.38 0-31.58-25.54-38.11-45.14C134.83 116.49 106.4 96 74.39 96 33.3 96 0 129.3 0 170.39v7.64c0 28.17 15.92 53.93 41.12 66.53 9.43 4.71 9.43 18.17 0 22.88C15.92 280.04 0 305.8 0 333.97v7.64C0 382.7 33.3 416 74.38 416c32.02 0 60.44-20.49 70.57-50.86 7.68-23.03 11.6-45.14 38.11-45.14h273.87c27.38 0 31.58 25.54 38.11 45.14C505.17 395.51 533.6 416 565.61 416c41.08 0 74.38-33.3 74.38-74.39v-7.64c0-28.18-15.92-53.93-41.12-66.53-9.42-4.71-9.42-18.17.01-22.88z"/></svg>',book:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M448 360V24c0-13.3-10.7-24-24-24H96C43 0 0 43 0 96v320c0 53 43 96 96 96h328c13.3 0 24-10.7 24-24v-16c0-7.5-3.5-14.3-8.9-18.7-4.2-15.4-4.2-59.3 0-74.7 5.4-4.3 8.9-11.1 8.9-18.6zM128 134c0-3.3 2.7-6 6-6h212c3.3 0 6 2.7 6 6v20c0 3.3-2.7 6-6 6H134c-3.3 0-6-2.7-6-6v-20zm0 64c0-3.3 2.7-6 6-6h212c3.3 0 6 2.7 6 6v20c0 3.3-2.7 6-6 6H134c-3.3 0-6-2.7-6-6v-20zm253.4 250H96c-17.7 0-32-14.3-32-32 0-17.6 14.4-32 32-32h285.4c-1.9 17.1-1.9 46.9 0 64z"/></svg>',backspace:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M576 64H205.26A63.97 63.97 0 0 0 160 82.75L9.37 233.37c-12.5 12.5-12.5 32.76 0 45.25L160 429.25c12 12 28.28 18.75 45.25 18.75H576c35.35 0 64-28.65 64-64V128c0-35.35-28.65-64-64-64zm-84.69 254.06c6.25 6.25 6.25 16.38 0 22.63l-22.62 22.62c-6.25 6.25-16.38 6.25-22.63 0L384 301.25l-62.06 62.06c-6.25 6.25-16.38 6.25-22.63 0l-22.62-22.62c-6.25-6.25-6.25-16.38 0-22.63L338.75 256l-62.06-62.06c-6.25-6.25-6.25-16.38 0-22.63l22.62-22.62c6.25-6.25 16.38-6.25 22.63 0L384 210.75l62.06-62.06c6.25-6.25 16.38-6.25 22.63 0l22.62 22.62c6.25 6.25 6.25 16.38 0 22.63L429.25 256l62.06 62.06z"/></svg>',"angle-right":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg>',trash:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16zM53.2 467a48 48 0 0 0 47.9 45h245.8a48 48 0 0 0 47.9-45L416 128H32z"/></svg>',times:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"/></svg>',box:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M509.5 184.6L458.9 32.8C452.4 13.2 434.1 0 413.4 0H272v192h238.7c-.4-2.5-.4-5-1.2-7.4zM240 0H98.6c-20.7 0-39 13.2-45.5 32.8L2.5 184.6c-.8 2.4-.8 4.9-1.2 7.4H240V0zM0 224v240c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V224H0z"/></svg>',"book-open":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M542.22 32.05c-54.8 3.11-163.72 14.43-230.96 55.59-4.64 2.84-7.27 7.89-7.27 13.17v363.87c0 11.55 12.63 18.85 23.28 13.49 69.18-34.82 169.23-44.32 218.7-46.92 16.89-.89 30.02-14.43 30.02-30.66V62.75c.01-17.71-15.35-31.74-33.77-30.7zM264.73 87.64C197.5 46.48 88.58 35.17 33.78 32.05 15.36 31.01 0 45.04 0 62.75V400.6c0 16.24 13.13 29.78 30.02 30.66 49.49 2.6 149.59 12.11 218.77 46.95 10.62 5.35 23.21-1.94 23.21-13.46V100.63c0-5.29-2.62-10.14-7.27-12.99z"/></svg>',"shield-alt":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M466.5 83.7l-192-80a48.15 48.15 0 0 0-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z"/></svg>',brain:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M208 0c-29.9 0-54.7 20.5-61.8 48.2-.8 0-1.4-.2-2.2-.2-35.3 0-64 28.7-64 64 0 4.8.6 9.5 1.7 14C52.5 138 32 166.6 32 200c0 12.6 3.2 24.3 8.3 34.9C16.3 248.7 0 274.3 0 304c0 33.3 20.4 61.9 49.4 73.9-.9 4.6-1.4 9.3-1.4 14.1 0 39.8 32.2 72 72 72 4.1 0 8.1-.5 12-1.2 9.6 28.5 36.2 49.2 68 49.2 39.8 0 72-32.2 72-72V64c0-35.3-28.7-64-64-64zm368 304c0-29.7-16.3-55.3-40.3-69.1 5.2-10.6 8.3-22.3 8.3-34.9 0-33.4-20.5-62-49.7-74 1-4.5 1.7-9.2 1.7-14 0-35.3-28.7-64-64-64-.8 0-1.5.2-2.2.2C422.7 20.5 397.9 0 368 0c-35.3 0-64 28.6-64 64v376c0 39.8 32.2 72 72 72 31.8 0 58.4-20.7 68-49.2 3.9.7 7.9 1.2 12 1.2 39.8 0 72-32.2 72-72 0-4.8-.5-9.5-1.4-14.1 29-12 49.4-40.6 49.4-73.9z"/></svg>',"chevron-up":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z"/></svg>',"chevron-down":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 284.505l154.745-154.021c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"/></svg>',"chevron-left":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z"/></svg>',"chevron-right":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>',briefcase:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M320 336c0 8.84-7.16 16-16 16h-96c-8.84 0-16-7.16-16-16v-48H0v144c0 25.6 22.4 48 48 48h416c25.6 0 48-22.4 48-48V288H320v48zm144-208h-80V80c0-25.6-22.4-48-48-48H176c-25.6 0-48 22.4-48 48v48H48c-25.6 0-48 22.4-48 48v80h512v-80c0-25.6-22.4-48-48-48zm-144 0H192V96h128v32z"/></svg>',check:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg>',edit:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M402.6 83.2l90.2 90.2c3.8 3.8 3.8 10 0 13.8L274.4 405.6l-92.8 10.3c-12.4 1.4-22.9-9.1-21.5-21.5l10.3-92.8L388.8 83.2c3.8-3.8 10-3.8 13.8 0zm162-22.9l-48.8-48.8c-15.2-15.2-39.9-15.2-55.2 0l-35.4 35.4c-3.8 3.8-3.8 10 0 13.8l90.2 90.2c3.8 3.8 10 3.8 13.8 0l35.4-35.4c15.2-15.3 15.2-40 0-55.2zM384 346.2V448H64V128h229.8c3.2 0 6.2-1.3 8.5-3.5l40-40c7.6-7.6 2.2-20.5-8.5-20.5H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V306.2c0-10.7-12.9-16-20.5-8.5l-40 40c-2.2 2.3-3.5 5.3-3.5 8.5z"/></svg>',heartbeat:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M320.2 243.8l-49.7 99.4c-6 12.1-23.4 11.7-28.9-.6l-56.9-126.3-30 71.7H60.6l182.5 186.5c7.1 7.3 18.6 7.3 25.7 0L451.4 288H342.3l-22.1-44.2zM473.7 73.9l-2.4-2.5c-51.5-52.6-135.8-52.6-187.4 0L256 100l-27.9-28.5c-51.5-52.7-135.9-52.7-187.4 0l-2.4 2.4C-10.4 123.7-12.5 203 31 256h102.4l35.9-86.2c5.4-12.9 23.6-13.2 29.4-.4l58.2 129.3 49-97.9c5.9-11.8 22.7-11.8 28.6 0l27.6 55.2H481c43.5-53 41.4-132.3-7.3-182.1z"/></svg>',plus:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 208H272V64c0-17.67-14.33-32-32-32h-32c-17.67 0-32 14.33-32 32v144H32c-17.67 0-32 14.33-32 32v32c0 17.67 14.33 32 32 32h144v144c0 17.67 14.33 32 32 32h32c17.67 0 32-14.33 32-32V304h144c17.67 0 32-14.33 32-32v-32c0-17.67-14.33-32-32-32z"/></svg>',minus:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 208H32c-17.67 0-32 14.33-32 32v32c0 17.67 14.33 32 32 32h384c17.67 0 32-14.33 32-32v-32c0-17.67-14.33-32-32-32z"/></svg>',running:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 416 512"><path d="M272 96c26.51 0 48-21.49 48-48S298.51 0 272 0s-48 21.49-48 48 21.49 48 48 48zM113.69 317.47l-14.8 34.52H32c-17.67 0-32 14.33-32 32s14.33 32 32 32h77.45c19.25 0 36.58-11.44 44.11-29.09l8.79-20.52-10.67-6.3c-17.32-10.23-30.06-25.37-37.99-42.61zM384 223.99h-44.03l-26.06-53.25c-12.5-25.55-35.45-44.23-61.78-50.94l-71.08-21.14c-28.3-6.8-57.77-.55-80.84 17.14l-39.67 30.41c-14.03 10.75-16.69 30.83-5.92 44.86s30.84 16.66 44.86 5.92l39.69-30.41c7.67-5.89 17.44-8 25.27-6.14l14.7 4.37-37.46 87.39c-12.62 29.48-1.31 64.01 26.3 80.31l84.98 50.17-27.47 87.73c-5.28 16.86 4.11 34.81 20.97 40.09 3.19 1 6.41 1.48 9.58 1.48 13.61 0 26.23-8.77 30.52-22.45l31.64-101.06c5.91-20.77-2.89-43.08-21.64-54.39l-61.24-36.14 31.31-78.28 20.27 41.43c8 16.34 24.92 26.89 43.11 26.89H384c17.67 0 32-14.33 32-32s-14.33-31.99-32-31.99z"/></svg>',archive:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg>',pen:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M109.46 244.04l134.58-134.56-44.12-44.12-61.68 61.68a7.919 7.919 0 0 1-11.21 0l-11.21-11.21c-3.1-3.1-3.1-8.12 0-11.21l61.68-61.68-33.64-33.65C131.47-3.1 111.39-3.1 99 9.29L9.29 99c-12.38 12.39-12.39 32.47 0 44.86l100.17 100.18zm388.47-116.8c18.76-18.76 18.75-49.17 0-67.93l-45.25-45.25c-18.76-18.76-49.18-18.76-67.95 0l-46.02 46.01 113.2 113.2 46.02-46.03zM316.08 82.71l-297 296.96L.32 487.11c-2.53 14.49 10.09 27.11 24.59 24.56l107.45-18.84L429.28 195.9 316.08 82.71zm186.63 285.43l-33.64-33.64-61.68 61.68c-3.1 3.1-8.12 3.1-11.21 0l-11.21-11.21c-3.09-3.1-3.09-8.12 0-11.21l61.68-61.68-44.14-44.14L267.93 402.5l100.21 100.2c12.39 12.39 32.47 12.39 44.86 0l89.71-89.7c12.39-12.39 12.39-32.47 0-44.86z"/></svg>',comment:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32z"/></svg>',"paper-plane":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M476 3.2L12.5 270.6c-18.1 10.4-15.8 35.6 2.2 43.2L121 358.4l287.3-253.2c5.5-4.9 13.3 2.6 8.6 8.3L176 407v80.5c0 23.6 28.5 32.9 42.5 15.8L282 426l124.6 52.2c14.2 6 30.4-2.9 33-18.2l72-432C515 7.8 493.3-6.8 476 3.2z"/></svg>',dice:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M592 192H473.26c12.69 29.59 7.12 65.2-17 89.32L320 417.58V464c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48V240c0-26.51-21.49-48-48-48zM480 376c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24zm-46.37-186.7L258.7 14.37c-19.16-19.16-50.23-19.16-69.39 0L14.37 189.3c-19.16 19.16-19.16 50.23 0 69.39L189.3 433.63c19.16 19.16 50.23 19.16 69.39 0L433.63 258.7c19.16-19.17 19.16-50.24 0-69.4zM96 248c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24zm128 128c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24zm0-128c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24zm0-128c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24zm128 128c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24z"/></svg>',share:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M503.691 189.836L327.687 37.851C312.281 24.546 288 35.347 288 56.015v80.053C127.371 137.907 0 170.1 0 322.326c0 61.441 39.581 122.309 83.333 154.132 13.653 9.931 33.111-2.533 28.077-18.631C66.066 312.814 132.917 274.316 288 272.085V360c0 20.7 24.3 31.453 39.687 18.164l176.004-152c11.071-9.562 11.086-26.753 0-36.328z"/></svg>',users:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M96 224c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm448 0c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm32 32h-64c-17.6 0-33.5 7.1-45.1 18.6 40.3 22.1 68.9 62 75.1 109.4h66c17.7 0 32-14.3 32-32v-32c0-35.3-28.7-64-64-64zm-256 0c61.9 0 112-50.1 112-112S381.9 32 320 32 208 82.1 208 144s50.1 112 112 112zm76.8 32h-8.3c-20.8 10-43.9 16-68.5 16s-47.6-6-68.5-16h-8.3C179.6 288 128 339.6 128 403.2V432c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48v-28.8c0-63.6-51.6-115.2-115.2-115.2zm-223.7-13.4C161.5 263.1 145.6 256 128 256H64c-35.3 0-64 28.7-64 64v32c0 17.7 14.3 32 32 32h65.9c6.3-47.4 34.9-87.3 75.2-109.4z"/></svg>',clock:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"/></svg>',copy:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M320 448v40c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V120c0-13.255 10.745-24 24-24h72v296c0 30.879 25.121 56 56 56h168zm0-344V0H152c-13.255 0-24 10.745-24 24v368c0 13.255 10.745 24 24 24h272c13.255 0 24-10.745 24-24V128H344c-13.2 0-24-10.8-24-24zm120.971-31.029L375.029 7.029A24 24 0 0 0 358.059 0H352v96h96v-6.059a24 24 0 0 0-7.029-16.97z"/></svg>'}};if(window.indexedDB){FUDB.version=4,FUDB.tabList=["chars","libraries","chosenSet","lang","EULA"],FUDB.open=function(e=null){var t=window.indexedDB.open("FUDB",this.version);t.onupgradeneeded=function(e){var t=e.target.result;FUDB.tabList.forEach(function(e){t.objectStoreNames.contains(e)||t.createObjectStore(e,{keyPath:"id"})}),console.log(lang[currentLanguage][119])},t.onsuccess=function(t){FUDB.db=t.target.result,console.log(lang[currentLanguage][120]),null!=e&&e()},t.onerror=function(e){console.log(lang[currentLanguage][121]+e.target.error)}},FUDB.reset=function(){window.indexedDB.deleteDatabase("FUDB")};class e{constructor(e){this.tabName=e}add(e){var t=FUDB.db.transaction(this.tabName,"readwrite").objectStore(this.tabName).add({id:e.id,data:e.data});return t.onsuccess=function(e){console.log(lang[currentLanguage][122])},t.onerror=function(t){console.log(lang[currentLanguage][123]+e.id)},t}update(e){var t=FUDB.db.transaction(this.tabName,"readwrite").objectStore(this.tabName).put({id:e.id,data:e.data});return t.onsuccess=function(e){console.log(lang[currentLanguage][124])},t.onerror=function(t){console.log(lang[currentLanguage][123]+e.id)},t}get(e,t,n=null){var a=FUDB.db.transaction(this.tabName,"readonly").objectStore(this.tabName).get(e);a.onSuccessFn=t,a.onErrFn=n,a.onsuccess=function(e){void 0!==e.target.result?this.onSuccessFn(e.target.result):this.onErrFn()},a.onerror=function(t){console.log(lang[currentLanguage][125]+"'"+e+"'"),this.onErrFn&&this.onErrFn()}}keys(e){var t=FUDB.db.transaction(this.tabName,"readonly").objectStore(this.tabName).getAllKeys();t.onSuccessFn=e,t.onsuccess=function(e){e.target.result.length>0&&console.log(lang[currentLanguage][126]+"'"+e.target.source.name+"'."),this.onSuccessFn(e.target.result)},t.onerror=function(e){console.log(lang[currentLanguage][127]+this.tabName)}}delete(e,t){var n=FUDB.db.transaction(this.tabName,"readwrite").objectStore(this.tabName).delete(e);n.onSuccessFn=t,n.onsuccess=function(t){console.log("'"+e+"': "+lang[currentLanguage][129]),this.onSuccessFn()},n.onerror=function(t){console.log(lang[currentLanguage][128]+"'"+e+"'")}}}FUDB.chars=new e("chars"),FUDB.libraries=new e("libraries"),FUDB.chosenSet=new e("chosenSet"),FUDB.lang=new e("lang"),FUDB.EULA=new e("EULA")}else console.log(lang[currentLanguage][118]),document.getElementById("manageCache").style.display="none";function resetCache(){window.confirm(lang[currentLanguage][130])&&window.confirm(lang[currentLanguage][131])&&FUDB.reset()}function startUpCharacter(){characterInfo=createNewCharacter(),updateSheet()}function createNewCharacter(){let e={autosave:!1,name:"...",img:"",sheetColor:"",levels:{},des:{base:6,temp:6},int:{base:6,temp:6},vig:{base:6,temp:6},vol:{base:6,temp:6},status:{slow:!1,confused:!1,weak:!1,shaken:!1,enraged:!1,poisoned:!1},traits:{identity:"...",theme:"...",origin:"..."},bonds:[],equip:{main:null,secondary:null,armor:null,accessory:null,bonusAccessory:null},inventory:[],fabula:{current:3},hp:{current:0,max:0,mod:0},mp:{current:0,max:0,mod:0},ip:{current:0,max:6,mod:0},zenit:{current:0},initMod:0,pDefMod:0,mDefMod:0,skills:[],martial:{melee:!1,range:!1,armor:!1,shield:!1}};return e.peculiarity={pecName:lang[currentLanguage][132],pecDesc:lang[currentLanguage][133]},e.zeroPowerProgress=0,e.zeroPower={zeroName:lang[currentLanguage][134],zeroTrigger:lang[currentLanguage][135],zeroEffect:lang[currentLanguage][136]},e.notes=[],e}function setupEvents(){document.getElementById("closePopup").addEventListener("click",function(){document.getElementById("popup").style.display="none",setModal()}),document.getElementById("closePopup").appendChild(fetchSvgIcon("times")),"undefined"!=typeof Capacitor?document.getElementById("shareLobby").appendChild(fetchSvgIcon("share")):document.getElementById("shareLobby").appendChild(fetchSvgIcon("copy")),document.getElementById("popupContent").addEventListener("click",function(e){if(e.target&&"tip"==e.target.className){let t="/r "+e.target.innerHTML.replace("[","").replace("]","");waitForCallback=3,document.getElementById("rollResult").innerHTML="",sendInChat(t)}});let e=document.createElement("div");e.id="rollResult",e.innerHTML="",document.getElementById("popup").appendChild(e),document.getElementById("selectCharacterMode").addEventListener("click",function(e){selectToolkitMode("charSheet")}),document.getElementById("selectLibraryMode").addEventListener("click",function(e){selectToolkitMode("library")}),document.getElementById("selectListToEdit").addEventListener("change",function(e){document.getElementById("selectListToEdit").firstElementChild.setAttribute("hidden",""),populateEditorSelect(),document.getElementById("confirmObjectToEdit").disabled=!1,document.getElementById("duplicateObject").disabled=!1,document.getElementById("deleteObject").disabled=!1}),document.getElementById("confirmObjectToEdit").addEventListener("click",function(e){if(document.getElementById("confirmObjectToEdit").innerHTML==lang[currentLanguage][69]){document.getElementById("selectListToEdit").disabled=!0,document.getElementById("listToEdit").disabled=!0,openEditor(document.getElementById("listToEdit")[document.getElementById("listToEdit").selectedIndex].refObj,editLibrary,document.getElementById("libraryEditor")),document.getElementById("confirmObjectToEdit").innerHTML=lang[currentLanguage][137];let e=document.getElementById("selectListToEdit").value,t=document.getElementById("listToEdit")[document.getElementById("listToEdit").selectedIndex].refObj;if("classes"==e||"items"==e){let n=document.createElement("div");n.className="imgSelector";let a=document.createElement("img");a.id="newImgPreview";let l=document.createElement("input");l.setAttribute("type","file");let r=document.createElement("h3");r.innerHTML=lang[currentLanguage][138],r.style.marginBlockStart="0",a.src=data.img[e][Object.keys(data.img[e]).find(e=>e.toLowerCase()===t.NOME.toLowerCase())],l.addEventListener("change",function(e){encodeImage(this,function(e){a.src=e})}),n.appendChild(r),n.appendChild(a),n.appendChild(l),document.getElementById("libraryEditor").children[1].prepend(n)}}else document.getElementById("confirmObjectToEdit").innerHTML==lang[currentLanguage][137]&&resetEditorMenu()}),document.getElementById("duplicateObject").addEventListener("click",function(e){let t=document.getElementById("listToEdit")[document.getElementById("listToEdit").selectedIndex],n=null,a="";if(document.getElementById("newImgPreview")&&(n=document.getElementById("newImgPreview").src),window.confirm(lang[currentLanguage][139]+"'"+document.getElementById("listToEdit").value+"'?")){if(t.refObj.hasOwnProperty("arr")&&t.refObj.hasOwnProperty("idx"))a=progressiveNaming(t.text,t.refObj.arr),t.refObj.arr.push(a);else{let e=JSON.parse(JSON.stringify(t.refObj)),n=data[document.getElementById("selectListToEdit").value].map(function(e){return e.NOME});a=progressiveNaming(t.refObj.NOME,n),e.NOME=a,data[document.getElementById("selectListToEdit").value].push(e)}n&&(data.img[document.getElementById("selectListToEdit").value][a]=n),resetEditorMenu(),setLibraryToBeSaved(!0),populateEditorSelect()}}),document.getElementById("deleteObject").addEventListener("click",function(e){let t=document.getElementById("listToEdit")[document.getElementById("listToEdit").selectedIndex];if(window.confirm(lang[currentLanguage][140]+"'"+document.getElementById("listToEdit").value+"'?")){if(t.refObj.hasOwnProperty("arr")&&t.refObj.hasOwnProperty("idx"))t.refObj.arr.splice(t.refObj.idx,1);else{let e=t.refObj,n=data[document.getElementById("selectListToEdit").value];for(let t=0;t<n.length;t++)if(e.NOME===n[t].NOME){n.splice(t,1);break}}resetEditorMenu(),setLibraryToBeSaved(!0),populateEditorSelect()}}),document.getElementById("contextMenu").children[0].addEventListener("click",function(e){sendInChat(),setModal()}),document.getElementById("contextMenu").children[1].addEventListener("click",function(e){equip("main"),setModal()}),document.getElementById("contextMenu").children[2].addEventListener("click",function(e){equip("secondary"),setModal()}),document.getElementById("contextMenu").children[3].addEventListener("click",function(e){equip("armor"),setModal()}),document.getElementById("contextMenu").children[4].addEventListener("click",function(e){equip("accessory"),setModal()}),document.getElementById("contextMenu").children[5].addEventListener("click",function(e){equip("bonusAccessory"),setModal()}),document.getElementById("contextMenu").children[6].addEventListener("click",function(e){dropItem("before"),setModal()}),document.getElementById("contextMenu").children[7].addEventListener("click",function(e){dropItem("after"),setModal()}),document.getElementById("backItems").addEventListener("click",function(e){switchContextListPage(-1)}),document.getElementById("forwardItems").addEventListener("click",function(e){switchContextListPage(1)}),document.getElementById("loadPCImg").addEventListener("change",function(e){encodeImage(this,function(e){characterInfo.img=e,refreshProfileImage()})}),document.getElementById("levelRecap").appendChild(expandIcon(!0,document.getElementById("levelDetail"))),document.getElementById("combatStats").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("traits").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("bonds").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("equip").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("inventory").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("abilities").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("equipAb").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("spells").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("peculiarity").firstElementChild.appendChild(expandIcon(!0)),document.getElementById("zeroPower").firstElementChild.appendChild(expandIcon(!0)),document.getElementById("notes").firstElementChild.appendChild(expandIcon(!1)),document.getElementById("goldAndIP").appendChild(expandIcon(!1,document.getElementById("inventoryList")));let t=document.querySelectorAll("[setExpander='0']"),n=document.querySelectorAll("[setExpander='1']");for(let e=0;e<t.length;e++)t[e].appendChild(expandIcon());for(let e=0;e<n.length;e++)n[e].appendChild(expandIcon(!1));document.getElementById("colorPicker").addEventListener("change",function(e){characterInfo.sheetColor=e.target.value,editPalette()}),document.getElementById("desIcon").appendChild(fetchSvgIcon("running")),document.getElementById("intIcon").appendChild(fetchSvgIcon("bolt")),document.getElementById("vigIcon").appendChild(fetchSvgIcon("bone")),document.getElementById("volIcon").appendChild(fetchSvgIcon("book")),document.getElementById("desIcon").firstChild.popupContent=createRoller({type:"stats"}),document.getElementById("intIcon").firstChild.popupContent=createRoller({type:"stats"}),document.getElementById("vigIcon").firstChild.popupContent=createRoller({type:"stats"}),document.getElementById("volIcon").firstChild.popupContent=createRoller({type:"stats"}),document.getElementById("desTag").popupContent=createRoller({type:"stats"}),document.getElementById("intTag").popupContent=createRoller({type:"stats"}),document.getElementById("vigTag").popupContent=createRoller({type:"stats"}),document.getElementById("volTag").popupContent=createRoller({type:"stats"}),document.getElementById("rollForInitiative").popupContent=createRoller({type:"stats"}),document.getElementById("desIcon").addEventListener("click",showPopup),document.getElementById("intIcon").addEventListener("click",showPopup),document.getElementById("vigIcon").addEventListener("click",showPopup),document.getElementById("volIcon").addEventListener("click",showPopup),document.getElementById("desTag").addEventListener("click",showPopup),document.getElementById("intTag").addEventListener("click",showPopup),document.getElementById("vigTag").addEventListener("click",showPopup),document.getElementById("volTag").addEventListener("click",showPopup),document.getElementById("modalBckgr").addEventListener("click",function(e){setModal()}),document.getElementById("openCompendium").appendChild(fetchSvgIcon("archive")),document.getElementById("openGraphics").appendChild(fetchSvgIcon("pen")),document.getElementById("openMenu").appendChild(fetchSvgIcon("bars")),document.getElementById("openClocks").appendChild(fetchSvgIcon("clock")),document.getElementById("openLobby").appendChild(fetchSvgIcon("users")),document.getElementById("openChat").appendChild(fetchSvgIcon("comment")),document.getElementById("closeMenu").appendChild(fetchSvgIcon("times")),document.getElementById("closeLobby").appendChild(fetchSvgIcon("times")),document.getElementById("closeChat").appendChild(fetchSvgIcon("chevron-right")),document.getElementById("sendChatMsg").appendChild(fetchSvgIcon("paper-plane")),document.getElementById("closeModal").appendChild(fetchSvgIcon("times")),document.getElementById("closeEditor").appendChild(fetchSvgIcon("times")),document.getElementById("openCompendium").addEventListener("click",function(e){setModal()}),document.getElementById("openGraphics").addEventListener("click",function(e){setModal("graphFU")}),document.getElementById("openMenu").addEventListener("click",function(e){setModal("FUMenu")}),document.getElementById("openClocks").addEventListener("click",function(e){setModal("FUClocks")}),document.getElementById("openLobby").addEventListener("click",function(e){setModal("FULobby")}),document.getElementById("openChat").addEventListener("click",function(e){setModal("FUChat"),document.getElementById("chatLog").scrollTo(0,document.getElementById("chatLog").scrollHeight),document.getElementById("openChat").classList.remove("chatNotification")}),document.getElementById("closeMenu").addEventListener("click",function(e){setModal()}),document.getElementById("closeLobby").addEventListener("click",function(e){setModal()}),document.getElementById("closeChat").addEventListener("click",function(e){setModal(),document.getElementById("openChat").classList.remove("chatNotification")}),document.getElementById("sendChatMsg").addEventListener("click",function(e){sendMessage()});let a=!1;document.getElementById("msgToSend").addEventListener("keydown",function(e){"ShiftLeft"!=e.code&&"ShiftRight"!=e.code||(a=!0)}),document.getElementById("msgToSend").addEventListener("keyup",function(e){signalWriting(),"Enter"!=e.code&&"NumpadEnter"!=e.code&&13!==e.keyCode||a||sendMessage(),"ShiftLeft"!=e.code&&"ShiftRight"!=e.code||(a=!1)}),document.getElementById("closeModal").addEventListener("click",function(e){setModal()}),document.getElementById("closeEditor").addEventListener("click",function(e){setModal()}),document.getElementById("resetBtn").addEventListener("click",resetCache),document.getElementById("saveBtn").addEventListener("click",saveCharacter),document.getElementById("loadBtn").addEventListener("click",fetchCharFromMemory),document.getElementById("deleteBtn").addEventListener("click",deleteCharacter),document.getElementById("shareChar").addEventListener("click",function(){if(p2p.peer){let e=document.getElementById("listOfChars");e.value?window.confirm(lang[currentLanguage][141]+"'"+e.value+"'?")&&FUDB.chars.get(e.value,function(e){console.log(lang[currentLanguage][142]),shareCharacter(e.data,usListChar.value),console.log(lang[currentLanguage][143])},function(){console.log(lang[currentLanguage][144])}):console.log(lang[currentLanguage][144])}else alert(lang[currentLanguage][145])}),document.getElementById("exportChar").addEventListener("click",download),document.getElementById("autosaveFlag").addEventListener("click",function(e){void 0!==characterInfo.autosave&&(characterInfo.autosave=document.getElementById("autosaveFlag").checked)}),document.getElementById("loadLib").addEventListener("click",function(e){fetchLibraryFromMemory()}),document.getElementById("removeLib").addEventListener("click",deleteLibrary),document.getElementById("shareLib").addEventListener("click",function(){if(p2p.peer){let e=document.getElementById("listOfLibraries").value;null!=e?window.confirm(lang[currentLanguage][146]+"'"+e+"'?")&&FUDB.libraries.get(e,function(e){console.log(lang[currentLanguage][142]),shareLibrary(e.data,null,usListLib.value),console.log(lang[currentLanguage][143])},function(){console.log(lang[currentLanguage][147])}):console.log(lang[currentLanguage][147])}else alert(lang[currentLanguage][145])}),document.getElementById("broadcastLib").addEventListener("click",function(){if(p2p.peer){let e=document.getElementById("listOfLibraries").value;null!=e?window.confirm(lang[currentLanguage][146]+"'"+e+"'?")&&FUDB.libraries.get(e,function(e){console.log(lang[currentLanguage][142]),broadcastLibrary(e.data),console.log(lang[currentLanguage][143])},function(){console.log(lang[currentLanguage][147])}):console.log(lang[currentLanguage][147])}else alert(lang[currentLanguage][145])}),document.getElementById("shareLobby").addEventListener("click",function(){shareLobby()}),document.getElementById("kickUser").addEventListener("click",function(){if(p2p.peer&&p2p.master){let e=document.getElementById("usListKick").value;p2p.connList.filter(t=>t.peer===e).length>0?window.confirm(lang[currentLanguage][148]+"'"+p2p.connList.filter(t=>t.peer===e)[0].userName+"'?")&&kickUser(e):console.log(lang[currentLanguage][149])}else alert(lang[currentLanguage][145])}),document.getElementById("exportLib").addEventListener("click",downloadLibrary),document.getElementById("setLib").addEventListener("click",saveDefaultLibrary),document.getElementById("saveLib").addEventListener("click",saveLibraryPrompt),document.getElementById("charLoader").addEventListener("change",upload),document.getElementById("libraryLoader").addEventListener("change",uploadLibrary),document.getElementById("name").addEventListener("click",addName),document.getElementById("pecName").addEventListener("click",e=>{editPeculiarity(e,lang[currentLanguage][132],"pecName")}),document.getElementById("pecDesc").addEventListener("click",e=>{editPeculiarity(e,lang[currentLanguage][133],"pecDesc")}),document.getElementById("zeroName").addEventListener("click",e=>{editZeroPower(e,lang[currentLanguage][134],"zeroName")}),document.getElementById("zeroTrigger").addEventListener("click",e=>{editZeroPower(e,lang[currentLanguage][135],"zeroTrigger")}),document.getElementById("zeroEffect").addEventListener("click",e=>{editZeroPower(e,lang[currentLanguage][136],"zeroEffect")}),document.getElementById("rollForInitiative").addEventListener("click",e=>{showPopup(e),document.getElementById("pz1").value="des",document.getElementById("pz2").value="int",document.getElementById("pz3").value=calculateInitiative(characterInfo)}),document.getElementById("initiative").addEventListener("dblclick",addInitMod),document.getElementById("defense").addEventListener("dblclick",addPDefMod),document.getElementById("magDefense").addEventListener("dblclick",addMDefMod),document.getElementById("ip_max").addEventListener("click",addIpMod),document.getElementById("addNewClass").addEventListener("click",addClass),document.getElementById("addNewClass").style.width="100%";let l=fetchSvgIcon("plus");function r(e){let t=e.target.statParam;if("base"==t[1]){let n=Array.from(e.target.children).indexOf(e.target.querySelectorAll("[value='"+characterInfo[t[0]].base+"'")[0]),a=Array.from(e.target.children).indexOf(e.target.querySelectorAll("[value='"+characterInfo[t[0]].temp+"'")[0]);characterInfo[t[0]].temp=e.target[Math.min(e.target.children.length-1,Math.max(0,e.target.selectedIndex-(n-a)))].value}characterInfo[t[0]][t[1]]=Number(e.target.value),updateSheet()}l.style.margin="auto",document.getElementById("addNewClass").appendChild(l);function c(e){characterInfo.status[e.target.id]=e.target.checked,updateSheet()}["des","int","vig","vol"].forEach(function(e){let t=e.charAt(0).toUpperCase()+e.slice(1);document.getElementById("base"+t).statParam=[e,"base"],document.getElementById("temp"+t).statParam=[e,"temp"],document.getElementById("base"+t).addEventListener("change",r),document.getElementById("temp"+t).addEventListener("change",r)}),document.getElementById("slow").addEventListener("change",c),document.getElementById("confused").addEventListener("change",c),document.getElementById("weak").addEventListener("change",c),document.getElementById("shaken").addEventListener("change",c),document.getElementById("enraged").addEventListener("change",c),document.getElementById("poisoned").addEventListener("change",c),document.getElementById("identity").addEventListener("click",addTrait),document.getElementById("theme").addEventListener("click",addTrait),document.getElementById("origin").addEventListener("click",addTrait),document.getElementById("addNewBond").addEventListener("click",addBond),document.getElementById("addNewBond").appendChild(fetchSvgIcon("plus")),document.getElementById("mainHand").addEventListener("contextmenu",function(e){buildItemContextList("mainHand"),buildContextMenu(document.getElementById("mainHand"),[e.clientX,e.clientY],{directEquip:!0}),e.preventDefault(e)}),document.getElementById("secondaryHand").addEventListener("contextmenu",function(e){buildItemContextList("secondaryHand"),buildContextMenu(document.getElementById("secondaryHand"),[e.clientX,e.clientY],{directEquip:!0}),e.preventDefault(e)}),document.getElementById("armor").addEventListener("contextmenu",function(e){buildItemContextList("armor"),buildContextMenu(document.getElementById("armor"),[e.clientX,e.clientY],{directEquip:!0}),e.preventDefault(e)}),document.getElementById("accessory").addEventListener("contextmenu",function(e){buildItemContextList("accessory"),buildContextMenu(document.getElementById("accessory"),[e.clientX,e.clientY],{directEquip:!0}),e.preventDefault(e)}),document.getElementById("bonusAccessory").addEventListener("contextmenu",function(e){buildItemContextList("bonusAccessory"),buildContextMenu(document.getElementById("bonusAccessory"),[e.clientX,e.clientY],{directEquip:!0}),e.preventDefault(e)}),document.getElementById("mainHand").addEventListener("dragover",allowDrop),document.getElementById("secondaryHand").addEventListener("dragover",allowDrop),document.getElementById("armor").addEventListener("dragover",allowDrop),document.getElementById("accessory").addEventListener("dragover",allowDrop),document.getElementById("bonusAccessory").addEventListener("dragover",allowDrop),document.getElementById("mainHand").addEventListener("drop",function(e){equip(this.id)}),document.getElementById("secondaryHand").addEventListener("drop",function(e){equip(this.id)}),document.getElementById("armor").addEventListener("drop",function(e){equip(this.id)}),document.getElementById("accessory").addEventListener("drop",function(e){equip(this.id)}),document.getElementById("bonusAccessory").addEventListener("drop",function(e){equip(this.id)}),document.getElementById("removeMain").appendChild(fetchSvgIcon("trash")),document.getElementById("removeSecondary").appendChild(fetchSvgIcon("trash")),document.getElementById("removeArmor").appendChild(fetchSvgIcon("trash")),document.getElementById("removeAccessory").appendChild(fetchSvgIcon("trash")),document.getElementById("removeBonusAccessory").appendChild(fetchSvgIcon("trash")),document.getElementById("removeMain").firstChild.slot="main",document.getElementById("removeSecondary").firstChild.slot="secondary",document.getElementById("removeArmor").firstChild.slot="armor",document.getElementById("removeAccessory").firstChild.slot="accessory",document.getElementById("removeBonusAccessory").firstChild.slot="bonusAccessory",document.getElementById("removeMain").firstChild.addEventListener("click",unequip),document.getElementById("removeSecondary").firstChild.addEventListener("click",unequip),document.getElementById("removeArmor").firstChild.addEventListener("click",unequip),document.getElementById("removeAccessory").firstChild.addEventListener("click",unequip),document.getElementById("removeBonusAccessory").firstChild.addEventListener("click",unequip),document.getElementById("addInvContainer").addEventListener("click",function(e){addInventoryContainer()}),document.getElementById("addInvContainer").prepend(fetchSvgIcon("plus")),document.getElementById("addNote").addEventListener("click",function(e){addNewNote()}),document.getElementById("ipIcon").appendChild(fetchSvgIcon("briefcase")),document.getElementById("ipIcon").firstChild.popupContent=lang[currentLanguage][154],document.getElementById("ipIcon").firstChild.addEventListener("click",showPopup),document.getElementById("znIcon").appendChild(fetchSvgIcon("coins")),document.getElementById("fabula")||document.getElementById("scores").appendChild(createTracker("fabula")),document.getElementById("hp")||document.getElementById("scores").appendChild(createTracker("hp")),document.getElementById("mp")||document.getElementById("scores").appendChild(createTracker("mp")),document.getElementById("ip").addEventListener("change",()=>{updateScore(characterInfo.ip,document.getElementById("ip").value),updateSheet()}),document.getElementById("zenit").addEventListener("change",()=>{updateScore(characterInfo.zenit,document.getElementById("zenit").value),updateSheet()}),document.getElementById("book").addEventListener("click",function(){characterInfo.fabula.current++,document.getElementById("fabula").value=characterInfo.fabula.current})}function createRoller(e={}){let t=document.createElement("div");t.id="rollerPopup";let n=document.createElement("select"),a=document.createElement("select"),l=document.createElement("input");n.id="pz1",a.id="pz2",l.id="pz3",n.innerHTML="<option value='6'>d6</option>   \t\t<option value='8'>d8</option>   \t\t<option value='10'>d10</option>   \t\t<option value='12'>d12</option>\t\t\t<option value='20'>d20</option>",null!=typeof e.type&&"stats"==e.type&&(n.innerHTML="<option value='des'>"+lang[currentLanguage][7]+"</option>   \t\t\t\t<option value='int'>"+lang[currentLanguage][8]+"</option>   \t\t\t\t<option value='vig'>"+lang[currentLanguage][9]+"</option>   \t\t\t\t<option value='vol'>"+lang[currentLanguage][10]+"</option>"),a.innerHTML=n.innerHTML,l.type="number",t.appendChild(n),t.appendChild(a),t.appendChild(l);let r=document.createElement("button");return r.innerHTML=lang[currentLanguage][155],r.addEventListener("click",function(t){waitForCallback=3,document.getElementById("rollResult").innerHTML="";let n=document.getElementById("pz1").value,a=document.getElementById("pz2").value,l=document.getElementById("pz3").value;null!=typeof e.type&&"stats"==e.type&&(n=getTotalEffectiveStat(document.getElementById("pz1").value),a=getTotalEffectiveStat(document.getElementById("pz2").value)),sendInChat("/r 1d"+n+"+1d"+a+(l>=0&&""!=l?"+":"")+l)}),t.appendChild(r),t}function showPopup(e){if(e.target.hasOwnProperty("popupContent")){let t=document.getElementById("popup");document.getElementById("popupContent").innerHTML="",e.target.popupContent instanceof HTMLElement?document.getElementById("popupContent").appendChild(e.target.popupContent):document.getElementById("popupContent").innerHTML=e.target.popupContent?e.target.popupContent:lang[currentLanguage][156],t.style.display="block";let n=null;n=document.getElementById("FUToolkit")?document.getElementById("FUToolkit"):document.body;e.target.x?e.target.x:(e.clientX,e.offsetX,document.getElementById("floatingtoolbar")&&n.scrollLeft),e.target.y?e.target.y:(e.clientY,e.offsetY,document.getElementById("floatingtoolbar")&&n.scrollTop);t.style.top="30%",t.style.height="auto",t.style.width="fit-content",t.style.minWidth="auto",setModal("popup")}}function turnOffPopup(){document.getElementById("popup").style.display="none",document.getElementById("sheetWrapper").removeEventListener("click",assignContainer)}function createTextInput(e,t){return createInput(e,t,"text")}function createInput(e,t,n){let a=document.createElement("input");a.type=n,a.setAttribute("newInput",!0),a.addEventListener("keydown",function(e){"Enter"==e.code||"NumpadEnter"==e.code||"Tab"==e.code||13===e.keyCode?document.activeElement.blur():"Escape"==e.code&&t()}),a.addEventListener("blur",function(t){e(t)}),a.addEventListener("click",function(e){a.getAttribute("newInput")&&(a.value="",a.removeAttribute("newInput"))});let l=fetchSvgIcon("check");return l.addEventListener("click",e),[a,l]}function addName(e){let t=createTextInput(function(e){updateName(t[0].value,document.getElementById("name"))},updateSheet);t.className="inRow",t[0].value=e.target.innerHTML,"..."!=e.target.innerHTML&&t[0].removeAttribute("newInput"),e.target.innerHTML="",e.target.appendChild(t[0]),e.target.appendChild(t[1])}function editPeculiarity(e,t,n){let a=createTextInput(function(e){updateValue(a[0].value,document.getElementById(n),t,["peculiarity",n])},updateSheet);a.className="inRow",a[0].value=e.target.innerHTML,"..."!=e.target.innerHTML&&a[0].removeAttribute("newInput"),e.target.innerHTML="",e.target.appendChild(a[0]),e.target.appendChild(a[1])}function editZeroPower(e,t,n){let a=createTextInput(function(e){updateValue(a[0].value,document.getElementById(n),t,["zeroPower",n])},updateSheet);a.className="inRow",a[0].value=e.target.innerHTML,"..."!=e.target.innerHTML&&a[0].removeAttribute("newInput"),e.target.innerHTML="",e.target.appendChild(a[0]),e.target.appendChild(a[1])}function updateValue(e,t,n="...",a=[]){""==e.trim()&&(e=n);let l=characterInfo,r="";if(a.length>0){for(let e=0;e<a.length;e++)""!=r&&l[r]&&(l=l[r]),r=a[e];l[r]=e}t.innerHTML=e}function addInitMod(e){addMod(e.target,"initMod")}function addPDefMod(e){addMod(e.target,"pDefMod")}function addMDefMod(e){addMod(e.target,"mDefMod")}function addIpMod(e){addMod(e.target,"ip.mod")}function addMod(e,t){let n=[],a=null,l="";"string"==typeof t?1==(n=t.split(".")).length?(a=characterInfo,l=t):(a=characterInfo[n[0]],l=n[1]):(a=t,l="mod");let r=createInput(function(t){a[l]=Number(r[0].value),e.classList.remove("inRow"),updateSheet(),updateClocks()},updateSheet,"number");r[0].value=a[l],r[0].removeAttribute("newInput"),r[0].style.width="5em",e.innerHTML=lang[currentLanguage][157],e.appendChild(r[0]),e.appendChild(r[1])}function addClass(e){let t=document.createElement("div");t.innerHTML=lang[currentLanguage][158];let n=document.createElement("select"),a=0;if(data.classes.forEach(function(e){if(characterInfo.levels[e])characterInfo.levels[e]<data.maxLv&&a++;else{let t=document.createElement("option");t.value=e,t.innerHTML=e,n.appendChild(t)}}),a<data.maxClasses){let e=fetchSvgIcon("check");e.addEventListener("click",function(e){populateClass(n)}),t.appendChild(n),t.appendChild(e),document.getElementById("addNewClass").style.display="none",document.getElementById("levelDetail").appendChild(t)}}function addTrait(e){let t=createTextInput(function(n){populateTrait(t[0],e.target)},updateSheet);t[0].value=e.target.innerHTML,"..."!=e.target.innerHTML&&t[0].removeAttribute("newInput"),e.target.innerHTML="",e.target.appendChild(t[0]),e.target.appendChild(t[1])}function addBond(e){let t="bond_"+characterInfo.bonds.length;if(!document.getElementById(t)){let e=document.createElement("div"),n=createTextInput(function(t){populateBond(n[0],e)},updateSheet);n[0].value=lang[currentLanguage][159],n[0].id=t,n[0].bondRef=t,n[1].bondRef=t,e.appendChild(n[0]),e.appendChild(n[1]),document.getElementById("bondsList").appendChild(e)}}function addItem(){let e={},t=null,n=document.createElement("div");n.className="inColumn",n.style.width="100%",data.items.forEach(function(a){let l=JSON.parse(JSON.stringify(a));e.hasOwnProperty(l.CATEGORIA)||(e[l.CATEGORIA]=createItemHeader(l.CATEGORIA),n.appendChild(e[l.CATEGORIA])),t=e[l.CATEGORIA];let r=document.createElement("div");r.className="inRow";let c=fetchSvgIcon("angle-right");c.style.fontSize="x-large",c.title=lang[currentLanguage][160];let i=buildItem(l);function o(e){characterInfo.inventory.push(this.passedItem),populateItem(this.passedItem),resetModalContent()}i.style.width="100%",r.appendChild(i),r.setAttribute("RARITA",l.RARITA),r.setAttribute("RAGGIO",l.RAGGIO),r.setAttribute("NOME",l.NOME),r.setAttribute("CATEGORIA",l.CATEGORIA),r.setAttribute("MARZIALE",l.MARZIALE),r.setAttribute("TIPO_DANNO",l.TIPO_DANNO),r.setAttribute("MANI",l.MANI),r.passedItem=l,c.passedItem=l,r.addEventListener("dblclick",o),c.addEventListener("click",o),r.appendChild(c),t.appendChild(r)}),document.getElementById("availableItems").appendChild(n)}function addSkill(){let e={},t=null;if(Object.keys(characterInfo.levels).length>0){let n=document.createElement("div");n.className="inColumn",n.style.width="100%";let a=0,l=!1;Object.keys(characterInfo.levels).forEach(function(e){characterInfo.levels[e]==data.maxLv&&a++}),characterInfo.skills.forEach(function(e){e.TIPO==lang[currentLanguage][168]&&a--}),a<=0&&(l=!0),data.abilities.forEach(function(a){let r=!1;if(a=JSON.parse(JSON.stringify(a)),hasAbility(characterInfo,a.NOME)){let e=hasAbility(characterInfo,a.NOME);Number(characterInfo.skills[e].MAX_LA)<=Number(characterInfo.skills[e].LA)&&(r=!0)}let c=hasAbility(characterInfo,a.REQUISITI);if(c&&!r&&Number(characterInfo.skills[c].MAX_LA)>1){let e=0;for(let t=0;t<characterInfo.skills.length;t++)characterInfo.skills[t].REQUISITI==a.REQUISITI&&(e+=characterInfo.skills[t].LA*characterInfo.skills[t].SUBTIPO);e>=Number(characterInfo.skills[c].LA)+(hasAbility(characterInfo,lang[currentLanguage][170]+"("+a.CLASSE.toUpperCase()+")")?2:0)&&(r=!0)}if(!r)if(a.TIPO==lang[currentLanguage][171]&&hasLevels(characterInfo,a.CLASSE))""!=a.REQUISITI&&(hasAbility(characterInfo,a.REQUISITI)||(r=!0));else if(a.TIPO==lang[currentLanguage][172]&&(hasLevels(characterInfo,a.CLASSE)||hasAbility(characterInfo,lang[currentLanguage][170]+"("+a.CLASSE.toUpperCase()+")"))||hasAbility(characterInfo,lang[currentLanguage][173])&&a.REQUISITI==lang[currentLanguage][173]||hasAbility(characterInfo,lang[currentLanguage][174])&&a.REQUISITI==lang[currentLanguage][174]){let e=0;hasAbility(characterInfo,a.REQUISITI)&&(e+=hasAbility(characterInfo,a.REQUISITI).LA),hasAbility(characterInfo,lang[currentLanguage][170]+"("+a.CLASSE.toUpperCase()+")")&&(e+=2),characterInfo.skills.filter(e=>e.REQUISITI==a.REQUISITI).length>=e&&(r=!0)}else a.TIPO!=lang[currentLanguage][168]||hasLevels(characterInfo,a.CLASSE)!=data.maxLv&&""!=a.CLASSE?r=!0:l&&(r=!0);if(!r){e.hasOwnProperty(a.CLASSE)||(e[a.CLASSE]=createClassHeader(a.CLASSE),n.appendChild(e[a.CLASSE])),t=e[a.CLASSE];let l=document.createElement("div");l.className="inRow";let r=fetchSvgIcon("angle-right");r.title=lang[currentLanguage][160];let c=buildAbility(a);function i(e){let t=hasAbility(characterInfo,this.passedSkill.NOME);t?characterInfo.skills[t].LA<Number(characterInfo.skills[t].MAX_LA)&&characterInfo.skills[t].LA++:(this.passedSkill.LA=1,characterInfo.skills.push(this.passedSkill)),updateSheet(),resetModalContent()}c.style.width="100%",l.appendChild(c),l.passedSkill=a,r.passedSkill=a,l.addEventListener("dblclick",i),r.addEventListener("click",i),l.appendChild(r),t.appendChild(l)}}),""!=n.innerHTML&&document.getElementById("availableAbilities").appendChild(n)}else document.getElementById("availableAbilities").innerHTML=lang[currentLanguage][169]}function addWiki(){data.wiki.length>0?(data.wiki.forEach(function(e){let t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div");t.style.margin="0 0 0.5em 0",t.style.filter="brightness(0.9) grayscale(1)",n.className="compendiumHeader",n.style.fontSize="large",n.style.fontWeight="bold",n.style.fontStyle="italic",n.innerHTML=e.NOME,n.appendChild(expandIcon(!0,a)),a.innerHTML=e.DESCRIZIONE,a.style.display="none",a.style.padding="0.5em",a.style.textAlign="left",a.className="infoBlock",t.appendChild(n),t.appendChild(a),document.getElementById("wikiEntries").appendChild(t)}),document.getElementById("wikiEntries").parentNode.style.removeProperty("display")):document.getElementById("wikiEntries").parentNode.style.display="none"}function updateName(e,t){updateValue(e,t,"...",["name"])}function populateClass(e=null){let t=null;if(e instanceof HTMLElement){if(t=e.value,!characterInfo.levels[t]){characterInfo.levels[t]=1;let e=null;for(let n=0;n<data.abilities.length;n++)if(t==data.abilities[n].CLASSE&&data.abilities[n].TIPO==lang[currentLanguage][175]){e=data.abilities[n];break}hasAbility(characterInfo,e.NOME)||characterInfo.skills.push(e)}updateSheet()}else{t=e.name;let n=document.createElement("div");n.className="classDetail",n.appendChild(fetchClassIcon(t));let a=document.createElement("span");a.innerHTML=t,n.appendChild(a);let l=document.createElement("input");l.id=t+"Lvl",l.type="number",l.min=1,l.max=data.maxLv,l.value=e.value,l.refClass=t,l.addEventListener("change",function(e){characterInfo.levels[e.target.refClass]=Number(e.target.value),updateSheet()}),n.appendChild(l);let r=fetchSvgIcon("times");r.refClass=t,r.addEventListener("click",removeClass),n.appendChild(r),document.getElementById("levelDetail").appendChild(n),document.getElementById("addNewClass").style.removeProperty("display")}}function removeClass(e,t=e.target.refClass){delete characterInfo.levels[t];for(let e=0;e<characterInfo.skills.length;e++)characterInfo.skills[e].CLASSE==t&&(characterInfo.skills.splice(e,1),e--);updateSheet()}function populateTrait(e,t){let n=null;e instanceof HTMLElement&&(n=e.value,characterInfo.traits[t.id]=n,t.innerHTML=""==n.trim()?"...":n)}function populateBond(e,t=null){let n=null,a=null;if(e instanceof HTMLElement?(n=e.value,a=e.bondRef):(n=e.name,a="bond_"+e.index),""!=n.trim()){let r=document.createElement("div");r.className="inRow";let c=0;function l(t,n,l){let r=document.createElement("select");r.id=a+"_"+n;let c=document.createElement("option"),i=document.createElement("option"),o=document.createElement("option");return c.value=0,i.value=1,o.value=2,c.text=l[0],i.text=l[1],o.text=l[2],r.appendChild(c),r.appendChild(i),r.appendChild(o),r.addEventListener("change",function(e){let t=e.target.id.split("_");characterInfo.bonds[t[1]].feelings[t[2]]=Number(e.target.value),updateSheet()}),e.feelings&&(r.selectedIndex=e.feelings[n]),r}characterInfo.bonds[e.index]&&(c=characterInfo.bonds[e.index].feelings.filter(e=>0!=e).length),r.innerHTML="<div>"+n+(c>0?" ["+c+"]":"")+"</div>",r.appendChild(l(0,0,["",lang[currentLanguage][176],lang[currentLanguage][177]])),r.appendChild(l(0,1,["",lang[currentLanguage][178],lang[currentLanguage][179]])),r.appendChild(l(0,2,["",lang[currentLanguage][180],lang[currentLanguage][181]]));let i=fetchSvgIcon("times");if(i.bondRef=a,i.addEventListener("click",function(e){r.parentNode.removeChild(r),delete characterInfo.bonds[Number(e.target.bondRef.substr(5))]}),r.appendChild(i),!e.feelings){let e={name:n,feelings:[0,0,0]};characterInfo.bonds[Number(a.substr(5))]=e}t&&(t.innerHTML=""),document.getElementById("bondsList").appendChild(r)}}function sendInChat(e=""){let t=document.getElementById("textchat-input");return""==e&&(e=document.querySelectorAll("[lastDragged]")[0].textForChat?document.querySelectorAll("[lastDragged]")[0].textForChat.value:document.querySelectorAll("[lastDragged]")[0].querySelectorAll("[class='infoBlock']")[0].textForChat.value),t?(t.querySelectorAll("[title='Text Chat Input']")[0].value=e,t.querySelectorAll(".btn")[0].click(),null):sendMessage(e)}function buildContextMenu(e,t,n={}){let a=!1;if(n.hasOwnProperty("equipButton")?document.getElementById("contextMenu").querySelectorAll("[equipButton]").forEach(function(e){e.style.removeProperty("display"),a=!0}):document.getElementById("contextMenu").querySelectorAll("[equipButton]").forEach(function(e){e.style.display="none"}),n.hasOwnProperty("invManage")?document.getElementById("contextMenu").querySelectorAll("[invManage]").forEach(function(e){e.style.removeProperty("display"),a=!0}):document.getElementById("contextMenu").querySelectorAll("[invManage]").forEach(function(e){e.style.display="none"}),n.hasOwnProperty("directEquip")?document.getElementById("contextMenu").querySelectorAll("[directEquip]").forEach(function(e){e.style.removeProperty("display"),a=!0}):document.getElementById("contextMenu").querySelectorAll("[directEquip]").forEach(function(e){e.style.display="none"}),n.hasOwnProperty("containerMng")?document.getElementById("contextMenu").querySelectorAll("[containerMng]").forEach(function(e){e.style.removeProperty("display"),a=!0}):document.getElementById("contextMenu").querySelectorAll("[containerMng]").forEach(function(e){e.style.display="none"}),n.hasOwnProperty("chatInter")&&document.getElementById("contextMenu").querySelectorAll("[chatInter]").forEach(function(e){e.style.removeProperty("display"),a=!0}),!a)return;setModal("contextMenu"),e.setAttribute("lastDragged","x");let l=document.getElementById("contextMenu"),r=null;r=document.getElementById("FUToolkit")?document.getElementById("FUToolkit"):document.body,l.style.left=t[0]-Math.max(0,l.offsetWidth+t[0]-r.clientWidth)+"px",l.style.top=t[1]-Math.max(0,l.offsetHeight+t[1]-r.clientHeight)+"px"}function populateItem(e){let t=document.createElement("div");t.setAttribute("draggable","true"),t.associatedItem=e,t.className="item",t.addEventListener("dragstart",startEquip),t.addEventListener("contextmenu",function(e){buildContextMenu(this,[e.clientX,e.clientY],{chatInter:!0,equipButton:!0,invManage:!0,containerMng:!0}),e.preventDefault(e)});let n=document.createElement("div");n.classList.add("popupMenu");let a=fetchSvgIcon("edit");a.classList.add("editIcon"),a.refObj=e,a.addEventListener("click",function(e){openEditor(e.target.refObj,editCharSheet),setModal("editorFU")});let l=fetchSvgIcon("trash");if(l.classList.add("closeIcon"),l.itemToRemove=e,l.addEventListener("click",function(e){window.confirm(lang[currentLanguage][182])&&(removeFromInventory(e.target.itemToRemove),updateSheet())}),e.equipped){let e=document.createElement("span");e.className="equipIcon",e.innerHTML="E",t.appendChild(e)}return t.appendChild(buildItemForSheet(e)),n.appendChild(a),n.appendChild(l),t.appendChild(n),t.addEventListener("dragenter",function(e){t.classList.add("onHover")}),t.addEventListener("dragleave",function(e){t.classList.contains("onHover")&&t.classList.remove("onHover")}),t.addEventListener("drop",dropItem),document.getElementById("inventoryList").appendChild(t),t}function dropItem(e){let t=characterInfo.inventory,n=document.querySelectorAll("[lastDragged]")[0],a=t.indexOf(n.associatedItem),l=null;"before"==e&&n.previousSibling?(l=n.previousSibling).parentNode.insertBefore(n,l):"after"==e&&n.nextSibling?(l=n.nextSibling,n.nextSibling.parentNode.insertBefore(l,n)):l=this;let r=t.indexOf(l.associatedItem);t.splice(r,0,n.associatedItem),t.splice(a+(r>a?0:1),1),n.associatedItem.container==l.associatedItem.container&&n.associatedItem.container||(n.associatedItem.container=l.associatedItem.container),n.removeAttribute("lastDragged")}function assignContainer(e,t,n){t&&(t.associatedItem.container==e&&t.associatedItem.container||(t.removeAttribute("lastDragged"),n.appendChild(t),t.associatedItem.container=e))}function populateSkill(e){let t=null;t=e.targetContainer?e.targetContainer:document.getElementById("abilityList");let n=buildAbilityForSheet(e);n.setAttribute("draggable","true"),n.className="ability";let a=document.createElement("div");if(a.classList.add("popupMenu"),e.TIPO!=lang[currentLanguage][175]){if(n.refObj.LA<n.refObj.MAX_LA){let e=fetchSvgIcon("plus");e.classList.add("plusIcon"),e.refObj=n.refObj,e.addEventListener("click",function(e){n.refObj.LA++,updateSheet()}),a.appendChild(e)}let t=null;n.refObj.LA<=1?(t=fetchSvgIcon("trash")).addEventListener("click",function(e){window.confirm(lang[currentLanguage][183])&&(removeSkill(e.target.skillToRemove.NOME),updateSheet())}):(t=fetchSvgIcon("minus")).addEventListener("click",function(e){removeSkill(e.target.skillToRemove.NOME),updateSheet()}),t.classList.add("closeIcon"),t.skillToRemove=e,a.appendChild(t)}let l=fetchSvgIcon("edit");return l.classList.add("editIcon"),l.refObj=n.refObj,l.addEventListener("click",function(e){openEditor(e.target.refObj,editCharSheet),setModal("editorFU")}),a.appendChild(l),n.appendChild(a),t.appendChild(n),n}function editLibrary(e){uploadEditorValues(e)?(alert(lang[currentLanguage][186]+"'"+e.refObj.NOME+"'."),setLibraryToBeSaved(!0),populateEditorSelect()):alert(lang[currentLanguage][185]+"'"+e.refObj.NOME+"'."),resetEditorMenu()}function resetEditorMenu(){document.getElementById("libraryEditor").innerHTML=lang[currentLanguage][184],document.getElementById("selectListToEdit").disabled=!1,document.getElementById("listToEdit").disabled=!1,document.getElementById("confirmObjectToEdit").innerHTML=lang[currentLanguage][69]}function editCharSheet(e){uploadEditorValues(e),setModal(),updateSheet()}function removeSkill(e){for(let t=0;t<characterInfo.skills.length;t++)if(e===characterInfo.skills[t].NOME){if(characterInfo.skills[t].LA>1)characterInfo.skills[t].LA--;else{characterInfo.skills.splice(t,1);let n=0;for(;n<characterInfo.skills.length;)e==characterInfo.skills[n].REQUISITI?removeSkill(characterInfo.skills[n].NOME):n++}break}}function characterLevel(e){let t=0;return Object.keys(e.levels).forEach(function(n){t+=Number(e.levels[n])}),t}function calculateInitiative(e){let t=0+e.initMod;return Object.keys(e.equip).forEach(function(n){e.equip[n]&&(t+=Number(e.equip[n].MOD_INIZ))}),e.skills.forEach(function(e){t+=Number(e.MOD_INIZ)}),Object.keys(e.equip).forEach(function(n){if(e.equip[n]&&e.equip[n].AB_OGGETTO)for(let a=0;a<e.equip[n].AB_OGGETTO.length;a++){let l=data.abilities.filter(t=>t.NOME==e.equip[n].AB_OGGETTO[a].name)[0];t+=Number(l.MOD_INIZ)}}),t}function calculateDefense(e){let t=Number(document.getElementById("tempDes").value),n=null,a=e.pDefMod;return Object.keys(e.equip).forEach(function(t){e.equip[t]&&(e.equip[t].TIPO_DIF==lang[currentLanguage][211]?n=Number(e.equip[t].MOD_DIF):e.equip[t].TIPO_DIF==lang[currentLanguage][220]&&(a+=Number(e.equip[t].MOD_DIF)))}),e.skills.forEach(function(e){a+=Number(e.MOD_DIF)}),Object.keys(e.equip).forEach(function(t){if(e.equip[t]&&e.equip[t].AB_OGGETTO)for(let n=0;n<e.equip[t].AB_OGGETTO.length;n++){let l=data.abilities.filter(a=>a.NOME==e.equip[t].AB_OGGETTO[n].name)[0];a+=Number(l.MOD_DIF)}}),(n||t)+a}function calculateMagicDefense(e){let t=Number(document.getElementById("tempInt").value),n=null,a=e.mDefMod;return Object.keys(e.equip).forEach(function(t){e.equip[t]&&(e.equip[t].TIPO_DIF_MAG==lang[currentLanguage][211]?n=Number(e.equip[t].MOD_DIFM):e.equip[t].TIPO_DIF_MAG==lang[currentLanguage][220]&&(a+=Number(e.equip[t].MOD_DIFM)))}),e.skills.forEach(function(e){a+=Number(e.MOD_DIFM)}),Object.keys(e.equip).forEach(function(t){if(e.equip[t]&&e.equip[t].AB_OGGETTO)for(let n=0;n<e.equip[t].AB_OGGETTO.length;n++){let l=data.abilities.filter(a=>a.NOME==e.equip[t].AB_OGGETTO[n].name)[0];a+=Number(l.MOD_DIFM)}}),(n||t)+a}function maxHp(e){let t=characterLevel(e)+5*e.vig.base,n=0;e.skills.forEach(function(t){if(-1==t.MOD_PV.indexOf("|"))n+=Number(t.MOD_PV)*(t.LA?t.LA:1);else{let a=t.MOD_PV.split("|");characterLevel(e)>=Number(a[0].split(":")[0])?n+=Number(a[1])*(t.LA?t.LA:1):n+=Number(a[0].split(":")[1])*(t.LA?t.LA:1)}});let a=0;return Object.keys(e.equip).forEach(function(t){if(e.equip[t]&&e.equip[t].AB_OGGETTO)for(let n=0;n<e.equip[t].AB_OGGETTO.length;n++){let l=data.abilities.filter(a=>a.NOME==e.equip[t].AB_OGGETTO[n].name)[0];if(-1==l.MOD_PV.indexOf("|"))a+=Number(l.MOD_PV)*(l.LA?l.LA:1);else{let t=l.MOD_PV.split("|");characterLevel(e)>=Number(t[0].split(":")[0])?a+=Number(t[1])*(l.LA?l.LA:1):a+=Number(t[0].split(":")[1])*(l.LA?l.LA:1)}}}),t+=n+a}function maxMp(e){let t=characterLevel(e)+5*e.vol.base,n=0;e.skills.forEach(function(t){if(-1==t.MOD_PM.indexOf("|"))n+=Number(t.MOD_PM)*(t.LA?t.LA:1);else{let a=t.MOD_PM.split("|");characterLevel(e)>=Number(a[0].split(":")[0])?n+=Number(a[1])*(t.LA?t.LA:1):n+=Number(a[0].split(":")[1])*(t.LA?t.LA:1)}});return Object.keys(e.equip).forEach(function(t){if(e.equip[t]&&e.equip[t].AB_OGGETTO)for(let a=0;a<e.equip[t].AB_OGGETTO.length;a++){let l=data.abilities.filter(n=>n.NOME==e.equip[t].AB_OGGETTO[a].name)[0];if(-1==l.MOD_PM.indexOf("|"))n+=Number(l.MOD_PM)*(l.LA?l.LA:1);else{let t=l.MOD_PM.split("|");characterLevel(e)>=Number(t[0].split(":")[0])?n+=Number(t[1])*(l.LA?l.LA:1):n+=Number(t[0].split(":")[1])*(l.LA?l.LA:1)}}}),t+=n+0}function maxIp(e){let t=6+e.ip.mod,n=0;e.skills.forEach(function(t){if(-1==t.MOD_PI.indexOf("|"))n+=Number(t.MOD_PI)*(t.LA?t.LA:1);else{let a=t.MOD_PI.split("|");characterLevel(e)>=Number(a[0].split(":")[0])?n+=Number(a[1])*(t.LA?t.LA:1):n+=Number(a[0].split(":")[1])*(t.LA?t.LA:1)}});return Object.keys(e.equip).forEach(function(t){if(e.equip[t]&&e.equip[t].AB_OGGETTO)for(let a=0;a<e.equip[t].AB_OGGETTO.length;a++){let l=data.abilities.filter(n=>n.NOME==e.equip[t].AB_OGGETTO[a].name)[0];if(-1==l.MOD_PI.indexOf("|"))n+=Number(l.MOD_PI)*(l.LA?l.LA:1);else{let t=l.MOD_PI.split("|");characterLevel(e)>=Number(t[0].split(":")[0])?n+=Number(t[1])*(l.LA?l.LA:1):n+=Number(t[0].split(":")[1])*(l.LA?l.LA:1)}}}),t+=n+0}function hasAbility(e,t){for(let n=0;n<e.skills.length;n++)if(e.skills[n].NOME==t)return n;return!1}function hasLevels(e,t){return!!e.levels[t]&&e.levels[t]}function hasCompetency(e){let t=!0;return"M"==e.MARZIALE&&((e.RAGGIO!=lang[currentLanguage][187]||characterInfo.martial.melee)&&(e.RAGGIO!=lang[currentLanguage][188]||characterInfo.martial.range)&&(e.CATEGORIA!=lang[currentLanguage][189]||characterInfo.martial.armor)&&(e.CATEGORIA!=lang[currentLanguage][190]||characterInfo.martial.shield)||(t=!1)),t}function updateScore(e,t){return e.current=Math.max(0,Math.min(Number(t),e.max?Number(e.max)+Number(e.mod):1/0)),checkOnCrisis(),e.current}function refreshTracker(e,t){updateScore(e.refObj,t),e.viewer.innerHTML=e.refObj.current,e.input.value=e.refObj.current,shareClocks()}function gainScore(e,t=null){let n=characterInfo[e];t?updateScore(n,Number(n.current)+t):n.max&&updateScore(n,Number.POSITIVE_INFINITY),updateSheet()}function heal(){gainScore("hp")}function refresh(){gainScore("mp")}function checkOnCrisis(){characterInfo.hp.current<=Math.floor(characterInfo.hp.max/2)&&characterInfo.hp.current>0?document.getElementById("heart").classList.add("crisisIcon"):document.getElementById("heart").classList.contains("crisisIcon")&&document.getElementById("heart").classList.remove("crisisIcon")}function getTotalEffectiveStat(e){let t=0,n="";void 0===characterInfo[e]?e.toLowerCase()==lang[currentLanguage][7].toLowerCase()?n="des":e.toLowerCase()==lang[currentLanguage][8].toLowerCase()?n="int":e.toLowerCase()==lang[currentLanguage][9].toLowerCase()?n="vig":e.toLowerCase()==lang[currentLanguage][10].toLowerCase()&&(n="vol"):n=e;let a=characterInfo[n].temp;return"des"===n?t=(characterInfo.status.slow?2:0)+(characterInfo.status.enraged?2:0):"int"===n?t=(characterInfo.status.confused?2:0)+(characterInfo.status.enraged?2:0):"vig"===n?t=(characterInfo.status.weak?2:0)+(characterInfo.status.poisoned?2:0):"vol"===n&&(t=(characterInfo.status.shaken?2:0)+(characterInfo.status.poisoned?2:0)),t>0&&20==characterInfo[n].temp&&(a=14),Math.max(6,a-t)}function addItemAbilities(e){let t=[];if(e.AB_OGGETTO)for(let n=0;n<e.AB_OGGETTO.length;n++)if((t=data.abilities.filter(t=>t.NOME==e.AB_OGGETTO[n].name)).length>0){let a=JSON.parse(JSON.stringify(t[0]));a.LA=e.AB_OGGETTO[n].la,document.getElementById("equipAbilities").appendChild(buildAbilityForSheet(a))}}function updateSheet(e=characterInfo){e.autosave&&saveCharacter(!0),""!=characterInfo.sheetColor?editPalette():editPalette("#fddc71"),document.getElementById("addNewClass").style.removeProperty("display"),document.getElementById("name").innerHTML=e.name,document.getElementById("charTotLevel").innerHTML=characterLevel(e);const t=document.getElementById("addNewClass");document.getElementById("levelDetail").innerHTML="",document.getElementById("levelDetail").append(t),Object.keys(e.levels).forEach(function(t){let n={};n.name=t,n.value=e.levels[t],populateClass(n)}),document.getElementById("baseDes").value=e.des.base,document.getElementById("baseInt").value=e.int.base,document.getElementById("baseVig").value=e.vig.base,document.getElementById("baseVol").value=e.vol.base,Object.keys(e.status).forEach(function(t){document.getElementById(t).checked=e.status[t]}),document.getElementById("tempDes").value=getTotalEffectiveStat("des"),document.getElementById("tempInt").value=getTotalEffectiveStat("int"),document.getElementById("tempVig").value=getTotalEffectiveStat("vig"),document.getElementById("tempVol").value=getTotalEffectiveStat("vol"),document.getElementById("identity").innerHTML=e.traits.identity,document.getElementById("theme").innerHTML=e.traits.theme,document.getElementById("origin").innerHTML=e.traits.origin,document.getElementById("bondsList").innerHTML="";let n=0;for(;n<e.bonds.length;)e.bonds[n]?n++:e.bonds.splice(n,1);e.bonds.forEach(function(e,t){e.index=t,populateBond(e)}),document.getElementById("inventoryList").innerHTML="",document.getElementById("contextMenu").querySelectorAll("[containerMng]").forEach(function(e){e.parentNode.removeChild(e)}),hasAbility(characterInfo,lang[currentLanguage][191])?(document.getElementById("accessory2").style.removeProperty("display"),document.getElementById("contextMenu").children[5].children[0].style.removeProperty("display")):(document.getElementById("accessory2").style.display="none",document.getElementById("contextMenu").children[5].children[0].display="none",unequip("bonusAccessory",!1)),e.inventory.forEach(function(t){let n=populateItem(t);if(t.equipped&&(e.equip[t.equipped]=t),t.container){let e=document.querySelectorAll("[containerName='"+t.container+"']"),a=null;(a=0==e.length?addInventoryContainer(t.container):e[0]).appendChild(n)}}),e.equip.main||(e.equip.main=JSON.parse(JSON.stringify(data.items[0]))),document.getElementById("equipAbilities").innerHTML="",document.getElementById("mainHand").innerHTML="",document.getElementById("mainHand").appendChild(buildItemForSheet(e.equip.main)),addItemAbilities(e.equip.main),document.getElementById("secondaryHand").innerHTML="",e.equip.secondary?(document.getElementById("secondaryHand").appendChild(buildItemForSheet(e.equip.secondary)),document.getElementById("removeSecondary").style.removeProperty("display"),addItemAbilities(e.equip.secondary)):(document.getElementById("secondaryHand").innerHTML=lang[currentLanguage][192],document.getElementById("removeSecondary").style.display="none"),e.equip.armor||(e.equip.armor=JSON.parse(JSON.stringify(data.items[1]))),document.getElementById("armor").innerHTML="",document.getElementById("armor").appendChild(buildItemForSheet(e.equip.armor)),addItemAbilities(e.equip.armor),e.equip.accessory?(document.getElementById("accessory").innerHTML="",document.getElementById("accessory").appendChild(buildItemForSheet(e.equip.accessory)),document.getElementById("removeAccessory").style.removeProperty("display"),addItemAbilities(e.equip.accessory)):(document.getElementById("accessory").innerHTML=lang[currentLanguage][192],document.getElementById("removeAccessory").style.display="none"),e.equip.bonusAccessory?(document.getElementById("bonusAccessory").innerHTML="",document.getElementById("bonusAccessory").appendChild(buildItemForSheet(e.equip.bonusAccessory)),document.getElementById("removeBonusAccessory").style.removeProperty("display"),addItemAbilities(e.equip.bonusAccessory)):(document.getElementById("bonusAccessory").innerHTML=lang[currentLanguage][192],document.getElementById("removeBonusAccessory").style.display="none"),""!=document.getElementById("equipAbilities").innerHTML?document.getElementById("equipAb").style.removeProperty("display"):document.getElementById("equipAb").style.display="none",document.getElementById("noteList").innerHTML="",e.notes.forEach(function(e){addNewNote(e)}),Object.keys(e.peculiarity).forEach(t=>{document.getElementById(t).innerHTML=e.peculiarity[t]}),Object.keys(e.zeroPower).forEach(t=>{document.getElementById(t).innerHTML=e.zeroPower[t]}),document.getElementById("zeroClock").innerHTML="",document.getElementById("zeroClock").appendChild(zeroPowerClock()),e.hp.max=maxHp(e),e.mp.max=maxMp(e),e.ip.max=maxIp(e),document.getElementById("ip").max=e.ip.max,document.getElementById("ip_max").innerHTML=lang[currentLanguage][193]+"<span>"+e.ip.max+"</span>",document.getElementById("ip").value=e.ip.current,document.getElementById("zenit").value=e.zenit.current,document.getElementById("scores").innerHTML="",document.getElementById("scores").appendChild(createTracker("fabula")),document.getElementById("scores").appendChild(createTracker("hp")),document.getElementById("scores").appendChild(createTracker("mp")),checkOnCrisis(),document.getElementById("initiative").innerHTML=calculateInitiative(e),document.getElementById("defense").innerHTML=calculateDefense(e),document.getElementById("magDefense").innerHTML=calculateMagicDefense(e);let a={},l="";if(refreshProfileImage(),e.skills){document.getElementById("abilityList").innerHTML="",document.getElementById("spellList").innerHTML="";let t={},n={};e.martial={melee:!1,range:!1,armor:!1,shield:!1},e.skills.forEach(function(l){""==l.CAPACITA?(t.hasOwnProperty(l.CLASSE)||(t[l.CLASSE]=createClassHeader(l.CLASSE),document.getElementById("abilityList").appendChild(t[l.CLASSE])),l.targetContainer=t[l.CLASSE],a[l.CLASSE]?a[l.CLASSE]+=l.LA:a[l.CLASSE]=l.LA):(n.hasOwnProperty(l.CLASSE)||(n[l.CLASSE]=createClassHeader(l.CLASSE),document.getElementById("spellList").appendChild(n[l.CLASSE])),l.targetContainer=n[l.CLASSE]),"1"==l.COMP_MIS&&(e.martial.melee=!0),"1"==l.COMP_DIS&&(e.martial.range=!0),"1"==l.COMP_ARM&&(e.martial.armor=!0),"1"==l.COMP_SCU&&(e.martial.shield=!0),populateSkill(l)}),Object.keys(e.equip).forEach(function(t){if(e.equip[t]&&e.equip[t].AB_OGGETTO)for(let n=0;n<e.equip[t].AB_OGGETTO.length;n++){let a=data.abilities.filter(a=>a.NOME==e.equip[t].AB_OGGETTO[n].name)[0];"1"==a.COMP_MIS&&(e.martial.melee=!0),"1"==a.COMP_DIS&&(e.martial.range=!0),"1"==a.COMP_ARM&&(e.martial.armor=!0),"1"==a.COMP_SCU&&(e.martial.shield=!0)}}),Object.keys(e.levels).forEach(function(t){let n=0;a[t]&&(n=a[t]),e.levels[t]>n&&(""==l?l=lang[currentLanguage][194]:l+=", ",l+=t+": "+(e.levels[t]-n)+lang[currentLanguage][195]),e.levels[t]<n&&(""==l?l=lang[currentLanguage][196]:l+=", ",l+=t+": "+(n-e.levels[t])+lang[currentLanguage][195])}),document.getElementById("memoAbilities").innerHTML=l}}function createClassHeader(e){let t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("span");return n.appendChild(fetchClassIcon(e)),n.className="inRow",a.innerHTML=e,n.appendChild(a),t.appendChild(n),t.setAttribute("categoryWrapper","skill"),t}function createItemHeader(e){let t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("span");return n.className="inRow",a.innerHTML=e,n.appendChild(a),t.appendChild(n),t.setAttribute("categoryWrapper","item"),t}function allowDrop(e){e.preventDefault()}function startEquip(e){let t=document.querySelectorAll("[lastDragged]");for(let e=0;e<t.length;e++)t[e].removeAttribute("lastDragged"),t[e].classList.contains("equipDenied")&&t[e].classList.remove("equipDenied");e.target.setAttribute("lastDragged","x")}function switchContextListPage(e){buildItemContextList(document.getElementById("listForEquip").getAttribute("slot"),Number(document.getElementById("listForEquip").getAttribute("lotPage"))+e)}function buildItemContextList(e,t=0){let n=getEquippableItemsList(e);if(0==n.length)document.getElementById("listForEquip").removeAttribute("slot"),document.getElementById("listForEquip").removeAttribute("lotPage"),document.getElementById("listForEquip").style.display="none",document.getElementById("backItems").style.display="none",document.getElementById("forwardItems").style.display="none",document.getElementById("listForEquip").parentNode.firstElementChild.style.display="none";else{document.getElementById("listForEquip").setAttribute("slot",e),document.getElementById("listForEquip").setAttribute("lotPage",t),document.getElementById("listForEquip").style.removeProperty("display"),document.getElementById("backItems").style.removeProperty("display"),document.getElementById("forwardItems").style.removeProperty("display"),document.getElementById("listForEquip").parentNode.firstElementChild.style.removeProperty("display"),document.getElementById("listForEquip").innerHTML="";let a=4,l=Math.min(n.length,a*(Math.max(0,t)+1)),r=Math.min(a*Math.max(0,t),l);for(let t=r;t<l;t++){let a=document.createElement("span");a.className="interactable",a.innerHTML=n[t].NOME,a.prepend(fetchItemIcon(n[t].NOME)),a.refObj=n[t],a.addEventListener("click",()=>{equip(e,a.refObj),setModal()}),document.getElementById("listForEquip").appendChild(a)}r>0?document.getElementById("backItems").style.removeProperty("visibility"):document.getElementById("backItems").style.visibility="hidden",l==n.length?document.getElementById("forwardItems").style.visibility="hidden":document.getElementById("forwardItems").style.removeProperty("visibility")}}function getEquippableItemsList(e){return characterInfo.inventory.filter(t=>!0===checkEquippable(e,t))}function checkEquippable(e,t){if(!hasCompetency(t))return!1;if("armor"==e){if(t.MANI==lang[currentLanguage][197]&&t.CATEGORIA==lang[currentLanguage][25])return!0}else if("accessory"==e||"bonusAccessory"==e){if(t.MANI==lang[currentLanguage][197]&&t.CATEGORIA==lang[currentLanguage][27])return!0}else{if("secondaryHand"==e||"secondary"==e){let e=!1;return t.MANI==lang[currentLanguage][198]?e=!0:t.MANI==lang[currentLanguage][199]&&hasAbility(characterInfo,lang[currentLanguage][200])&&[lang[currentLanguage][202],lang[currentLanguage][203],lang[currentLanguage][204],lang[currentLanguage][205]].includes(t.CATEGORIA)?hasAbility(characterInfo,lang[currentLanguage][201])?characterInfo.equip.main.MANI==lang[currentLanguage][199]?[lang[currentLanguage][202],lang[currentLanguage][203],lang[currentLanguage][204],lang[currentLanguage][205]].includes(characterInfo.equip.main.CATEGORIA)&&(e=!0):e=!0:t.CATEGORIA==characterInfo.equip.main.CATEGORIA&&(e=!0):t.MANI==lang[currentLanguage][206]&&characterInfo.equip.main&&(characterInfo.equip.main.MANI==lang[currentLanguage][199]?hasAbility(characterInfo,lang[currentLanguage][200])&&(hasAbility(characterInfo,lang[currentLanguage][201])?[lang[currentLanguage][202],lang[currentLanguage][203],lang[currentLanguage][204],lang[currentLanguage][205]].includes(characterInfo.equip.main.CATEGORIA)&&(e=!0):t.CATEGORIA==characterInfo.equip.main.CATEGORIA&&(e=!0)):hasAbility(characterInfo,lang[currentLanguage][201])?e=!0:t.CATEGORIA==characterInfo.equip.main.CATEGORIA&&(e=!0)),e}if(("mainHand"==e||"main"==e)&&(t.MANI==lang[currentLanguage][206]||t.MANI==lang[currentLanguage][199]||t.MANI==lang[currentLanguage][198]&&hasAbility(characterInfo,lang[currentLanguage][207])))return!0}}function equip(e,t=null){let n=null,a=null;if(a=t||document.querySelectorAll("[lastDragged]")[0].associatedItem,checkEquippable(n=e.indexOf("Hand")>-1?e.replace("Hand",""):e,a)){if(unequip(n,!1),unequipWithItem(a),characterInfo.equip[n]=a,a.equipped=n,"mainHand"==n||"main"==n)if(a.MANI==lang[currentLanguage][206])characterInfo.equip.secondary&&(a.CATEGORIA==characterInfo.equip.secondary.CATEGORIA||hasAbility(characterInfo,lang[currentLanguage][201])||characterInfo.equip.secondary.MANI==lang[currentLanguage][198]||unequip("secondary",!1));else if(a.MANI==lang[currentLanguage][199]&&characterInfo.equip.secondary){let e=!0;hasAbility(characterInfo,lang[currentLanguage][200])&&[lang[currentLanguage][202],lang[currentLanguage][203],lang[currentLanguage][204],lang[currentLanguage][205]].includes(a.CATEGORIA)&&(hasAbility(characterInfo,lang[currentLanguage][201])?[lang[currentLanguage][202],lang[currentLanguage][203],lang[currentLanguage][204],lang[currentLanguage][205]].includes(characterInfo.equip.secondary.CATEGORIA)&&(e=!1):a.CATEGORIA==characterInfo.equip.secondary.CATEGORIA&&(e=!1)),e&&unequip("secondary",!1)}updateSheet()}else document.querySelectorAll("[lastDragged]")[0].classList.add("equipDenied")}function unequip(e,t=!0){let n=null;n=e.target?e.target.slot:e,characterInfo.equip[n]&&characterInfo.equip[n].equipped&&delete characterInfo.equip[n].equipped,characterInfo.equip[n]=null,t&&updateSheet()}function unequipWithItem(e){e.equipped&&unequip(e.equipped,!1)}function removeFromInventory(e){unequipWithItem(e);for(let t=0;t<characterInfo.inventory.length;t++)if(e===characterInfo.inventory[t]){characterInfo.inventory.splice(t,1);break}}function addInventoryContainer(e=null){let t=document.createElement("div");t.className="itemContainer",t.style.borderWidth="3px";let n=document.createElement("div"),a=document.createElement("div");a.style.display="none";let l=document.createElement("div");l.classList.add("popupContainer");let r=fetchSvgIcon("backspace");if(r.refObj=a,r.addEventListener("click",function(e){if(window.confirm(lang[currentLanguage][208])){for(let t=0;t<e.target.refObj.children.length;t++)delete e.target.refObj.children[t].associatedItem.container;updateSheet()}}),l.appendChild(r),t.appendChild(l),t.appendChild(n),t.appendChild(a),t.addEventListener("dragover",function(e){e.preventDefault()}),document.getElementById("inventoryList").prepend(t),e)renameItemContainer(e,n,a);else{let e=createTextInput(function(t){renameItemContainer(e[0].value,n,a)});n.appendChild(e[0]),n.appendChild(e[1]),e[0].removeAttribute("newInput")}return a.setAttribute("containerName",e),a}function addNewNote(e=null){let t=document.createElement("div");t.className="item",t.style.borderWidth="3px";let n=document.createElement("div");n.className="inRow";let a=document.createElement("div");if(a.className="itemContainer",a.style.flexDirection="column",a.style.display="none",t.appendChild(n),t.appendChild(a),null==e){let e=createTextInput(function(t){characterInfo.notes.push({title:e[0].value,content:""}),updateSheet()});n.appendChild(e[0]),n.appendChild(e[1])}else{t.refObj=e;let l=document.createElement("div");l.innerHTML=e.title,l.addEventListener("dblclick",function(t){let a=l.innerHTML;n.innerHTML="";let r=createTextInput(function(t){e.title=r[0].value,updateSheet()},updateSheet);r[0].value=a,r[0].removeAttribute("newInput"),n.appendChild(r[0]),n.appendChild(r[1])}),n.appendChild(l);let r=document.createElement("div");r.appendChild(expandIcon(!0,a)),n.appendChild(r);let c=document.createElement("textarea");c.addEventListener("input",function(t){this.style.height="",this.style.height=Math.max(Math.min(200,c.scrollHeight),100)+"px",e.content=this.value,characterInfo.autosave&&saveCharacter(!0)}),c.style.width="100%",c.style.height=Math.max(Math.min(200,c.scrollHeight),100)+"px",c.style.resize="vertical",c.style.overflow="auto",c.innerHTML=e.content,a.appendChild(c);let i=document.createElement("div");i.classList.add("popupMenu");let o=null;(o=fetchSvgIcon("trash")).addEventListener("click",function(t){window.confirm(lang[currentLanguage][209])&&(characterInfo.notes.splice(characterInfo.notes.indexOf(e),1),updateSheet())}),o.classList.add("closeIcon"),i.appendChild(o),t.appendChild(i)}document.getElementById("noteList").appendChild(t)}function renameItemContainer(e,t,n){if(""!=e.trim()&&0==document.querySelectorAll('[containerName="'+e+'"]').length){let a=fetchSvgIcon("box");a.style.margin="5px";let l=document.createElement("div");l.style.margin="auto",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.innerHTML=e,n.setAttribute("containerName",e),l.addEventListener("dblclick",function(e){let a=t.textContent;t.innerHTML="";let l=createTextInput(function(e){for(let e=0;e<n.children.length;e++)n.children[e].associatedItem.container=l[0].value;renameItemContainer(l[0].value,t,n)},updateSheet);l[0].value=a,l[0].removeAttribute("newInput"),t.appendChild(l[0]),t.appendChild(l[1])}),n.parentNode.removeEventListener("drop",assignContainer),n.parentNode.addEventListener("drop",function(t){assignContainer(e,document.querySelectorAll("[lastDragged]")[0],n)});let r=document.createElement("div");r.innerHTML="<span>"+lang[currentLanguage][210]+"'"+e+"'</span>",r.setAttribute("containerMng",""),r.addEventListener("click",function(t){assignContainer(e,document.querySelectorAll("[lastDragged]")[0],n),setModal()}),document.getElementById("contextMenu").appendChild(r),t.innerHTML="",l.prepend(a),t.appendChild(l),t.appendChild(expandIcon())}}function expandIcon(e=!0,t=null){let n=fetchSvgIcon("chevron-down");return e||(n.style.transform="rotate(180deg)"),n.addEventListener("click",function(e){let n=null;"none"==(n=t||e.target.parentNode.nextElementSibling).style.display?(n.style.removeProperty("display"),e.target.style.transform="rotate(180deg)"):(n.style.display="none",e.target.style.transform="rotate(0deg)")}),n}function buildItem(e){let t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div");n.appendChild(fetchItemIcon(e.NOME));let l=document.createElement("span");l.innerHTML=e.NOME,n.appendChild(l),n.appendChild(expandIcon(!0,a)),n.style.display="flex",n.style.alignItems="center",a.innerHTML="";let r=""!=e.MARZIALE?"[<span style='color: transparent;text-shadow: 0 0 0 "+(hasCompetency(e)?"black":"red")+";'></span>]":"";return e.CATEGORIA==lang[currentLanguage][189]||e.CATEGORIA==lang[currentLanguage][190]?(a.innerHTML+="<div style='border-bottom: solid 1px black;'>"+e.CATEGORIA+r+" - "+e.COSTO+"Z</div>",a.innerHTML+="<div>"+lang[currentLanguage][19]+": "+(e.TIPO_DIF!=lang[currentLanguage][211]&&"-"!=e.MOD_DIF.charAt(0)?"+":"")+e.MOD_DIF+", "+lang[currentLanguage][20]+": "+(e.TIPO_DIF!=lang[currentLanguage][211]&&"-"!=e.MOD_DIFM.charAt(0)?"+":"")+e.MOD_DIFM+", "+lang[currentLanguage][18]+": "+e.MOD_INIZ+"</div>"):e.CATEGORIA!=lang[currentLanguage][27]&&(a.innerHTML+="<div style='border-bottom: solid 1px black;'>"+e.CATEGORIA+" ("+e.RAGGIO+")"+r+", Mani: "+e.MANI+" - "+e.COSTO+"Z</div>",a.innerHTML+="<div class='inRow' style='border-bottom: solid 1px black;'><span class='interactable'>TP: <span class='tp'>"+e.PRECISIONE+"</span></span><span class='interactable'><span class='td'>"+e.DANNO+"</span> "+e.TIPO_DANNO+"</span></div>"),a.innerHTML+="<div>"+lang[currentLanguage][212]+": "+encodeHTML(e.QUALITA)+"</div>",a.style.display="none",a.style.flexDirection="column",a.className="infoBlock",a.textForChat={get value(){let t="\n**"+e.NOME+"**";for(let e=0;e<a.children.length;e++)t+="\n"+a.children[e].textContent;return t}},t.refObj=e,t.appendChild(n),t.appendChild(a),t.className="item",t.slot=e,t}function buildItemForSheet(e){let t=buildItem(e);return applySpecialNotation(t),t}function buildAbility(e){let t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div");n.innerHTML=(e.TIPO==lang[currentLanguage][168]?"["+lang[currentLanguage][168]+"] ":"")+(e.TIPO==lang[currentLanguage][172]?lang[currentLanguage][172]+": ":"")+("x"==e.OFFENSIVO?"[] ":"")+e.NOME,n.appendChild(expandIcon(!0,a)),n.style.display="flex",n.style.alignItems="center",a.innerHTML="",a.innerHTML+="<div style='border-bottom: solid 1px black;'> "+(Number(e.MAX_LA)>1?lang[currentLanguage][213]+e.MAX_LA+(e.LA?", "+lang[currentLanguage][214]+": "+e.LA:""):"")+"</div>";let l="";return""!=e.COSTO.trim()&&(l+=lang[currentLanguage][215]+": "+e.COSTO+", "),""!=e.BERSAGLIO.trim()&&(l+=""!=l?", ":"",l+=lang[currentLanguage][216]+": "+e.BERSAGLIO+", "),""!=e.DURATA.trim()&&(l+=""!=l?", ":"",l+=lang[currentLanguage][217]+": "+e.DURATA),""!=l&&(a.innerHTML+="<div style='border-bottom: solid 1px black;'>",a.innerHTML+=l,a.innerHTML+="</div>"),""!=e.REQUISITI&&(a.innerHTML+="<div style='border-bottom: solid 1px black;'>"+lang[currentLanguage][218]+": "+e.REQUISITI+"</div>"),a.innerHTML+="<div> "+encodeHTML(e.TESTO)+"</div>",a.style.display="none",a.style.flexDirection="column",a.className="infoBlock",a.textForChat={get value(){let e="\n**"+n.textContent+"**";for(let t=0;t<a.children.length;t++)e+="\n"+a.children[t].textContent;return e}},t.refObj=e,t.appendChild(n),t.appendChild(a),t.className="ability",t}function buildAbilityForSheet(e){let t=buildAbility(e);return applySpecialNotation(t),t.addEventListener("contextmenu",function(e){buildContextMenu(this,[e.clientX,e.clientY],{chatInter:!0}),e.preventDefault(e)}),t}function applySpecialNotation(e){for(let t of e.getElementsByClassName("tp")){let e=t.textContent.replace("[","").replace("]","|").split("|")[0].split("+");""!==e[0].trim().toLowerCase()&&(t.popupContent="<span class='tip'>[d"+getTotalEffectiveStat(e[0].trim().toLowerCase())+" + d"+getTotalEffectiveStat(e[1].trim().toLowerCase())+"]",t.textContent.split("]").length>1&&(t.popupContent+=t.textContent.split("]")[1].trim()),t.popupContent+="</span>",t.addEventListener("click",showPopup))}for(let t of e.getElementsByClassName("td"));for(let t of e.getElementsByClassName("la"))e.refObj.LA&&(t.innerHTML=t.innerHTML.replace(lang[currentLanguage][219],"<span style='color:green;font-weight:bolder'>"+e.refObj.LA+"</span>"))}function fetchItemIcon(e){return fetchIcon(e,"items")}function fetchClassIcon(e){return fetchIcon(e,"classes")}function fetchSvgIcon(e){return fetchIcon(e,"svg","svg")}function fetchIcon(e,t,n="jpg"){let a=document.createElement("img");if(a.className="icon",a.src=fallbackImgB64,"svg"==n)systemData.svg[e]?a.src="data:image/svg+xml;charset=UTF-8,"+systemData.svg[e]:a.src=fallbackImgB64,a.className="falt",a.draggable=!1,a.addEventListener("mousedown",async function(){a.classList.add("clicked"),await sleep(100),a.classList.remove("clicked")});else{let n=data.img[t][Object.keys(data.img[t]).find(t=>t.toLowerCase()===e.toLowerCase())];a.src=n||fallbackImgB64}return a}function setModal(e="compendiumFU"){if("none"!=document.getElementById("popup").style.display&&(document.getElementById("popup").style.display="none",document.getElementById("rollResult")&&(document.getElementById("rollResult").innerHTML="")),"none"==document.getElementById("modalBckgr").style.display)"compendiumFU"==e&&resetModalContent(),document.getElementById("modalBckgr").style.removeProperty("display"),document.getElementById(e).style.removeProperty("display");else{let e=document.querySelectorAll("[modal]");for(let t=0;t<e.length;t++)e[t].style.display="none"}document.querySelectorAll("[lastDragged]").length>0&&document.querySelectorAll("[lastDragged]")[0].removeAttribute("lastDragged")}function resetModalContent(){let e=document.getElementById("availableItems").firstElementChild;document.getElementById("availableItems").innerHTML="",document.getElementById("availableAbilities").innerHTML="",document.getElementById("wikiEntries").innerHTML="",document.getElementById("availableItems").appendChild(e),addItem(),addSkill(),addWiki(),applyItemFilter()}function createRelatedNumberInput(e=null){let t=document.createElement("input");return t.type="number",t.min="1",e?(t.max=e.max,t.value=Math.min(e.la,t.max)):t.value=1,t}function generateListOptions(e,t=null){let n=document.createElement("div");n.style.display="flex",n.style.flexDirection="row",n.style.alignItems="center",n.style.justifyContent="center";let a=document.createElement("select");a.style.maxWidth="50%";let l=document.createElement("option"),r=fetchSvgIcon("trash");return r.addEventListener("click",function(e){r.parentNode.parentNode.removeChild(r.parentNode)}),data[e].forEach(function(e){let t=l.cloneNode();t.value=e.NOME,t.text=e.NOME,a.appendChild(t)}),t?(a.value=t.name,a.refInput=createRelatedNumberInput(t)):a.refInput=createRelatedNumberInput({name:a[0].value,la:1,max:data[e].filter(e=>e.NOME==a[0].value)[0].MAX_LA}),a.addEventListener("change",function(t){let n=createRelatedNumberInput({name:a.value,la:a.refInput.value,max:data[e].filter(e=>e.NOME==a.value)[0].MAX_LA});a.refInput.parentNode.insertBefore(n,a.refInput),a.refInput.parentNode.removeChild(a.refInput),a.refInput=n}),n.appendChild(a),n.appendChild(a.refInput),n.appendChild(r),n}function openEditor(e,t,n=null){let a=document.createElement("div");a.style.position="relative",a.style.margin="auto",a.style.maxWidth="80%";let l=null;e.hasOwnProperty("EDITOR")?l=data.editorTags[e.EDITOR]:e.RARITA?l=data.editorTags.OGGETTO:""==e.CLASSE||e.CLASSE?l=data.editorTags.ABILITA:e.DESCRIZIONE&&(l=data.editorTags.WIKI),null===l&&(a.descriptionRefs=e,e={NOME:a.descriptionRefs.arr[a.descriptionRefs.idx]},l={NOME:{label:"Nome",tag:"input",inputType:"text"}}),l.hasOwnProperty("CLASSE")&&(l.CLASSE.values=data.classes),a.refObj=e,Object.keys(l).forEach(function(t){if(l.hasOwnProperty(t)){let n=l[t],r=document.createElement("div");r.className="elementBits";let c=document.createElement("span");c.innerHTML=n.label;let i=null;if(i="list"==n.tag?document.createElement("div"):document.createElement(n.tag),"select"==n.tag){let e=document.createElement("option");n.values.forEach(function(t){let n=e.cloneNode();n.value=t,n.text=t,i.appendChild(n)})}else if("input"==n.tag)i.type=n.inputType;else if("textarea"==n.tag)i.style.height="10em",i.style.width="100%",i.style.resize="none";else if("list"==n.tag){i.style.display="flex",i.style.flexDirection="column";let a=fetchSvgIcon("plus");if(a.list=n.values,a.style.width="100%",a.addEventListener("click",function(e){a.parentNode.appendChild(generateListOptions(a.list))}),i.appendChild(a),e[t]){let n=0,l=Number.POSITIVE_INFINITY;e.MAX_AB_OGGETTO&&(l=Number(e.MAX_AB_OGGETTO)),e[t].forEach(function(e){e.max=data.abilities.filter(t=>t.NOME==e.name)[0].MAX_LA,l>n&&(e.max=Math.min(l-n,e.la),e.la=Math.min(e.la,e.max),n+=e.max,a.parentNode.appendChild(generateListOptions(a.list,e)))})}}"list"!=n.tag&&(i.value=e[t]),i.setAttribute("property",t),i.propType=n.tag,r.appendChild(c),r.appendChild(i),a.appendChild(r)}});let r=document.createElement("div");r.className="button",r.innerHTML=lang[currentLanguage][221],r.style.position="relative",r.addEventListener("click",function(e){t(a)}),null==n&&(n=document.getElementById("editorContent")),n.innerHTML="",n.appendChild(a),n.prepend(r)}function uploadEditorValues(e){let t=e.refObj,n=!1;if(e.querySelectorAll("[property]").forEach(function(a){if(e.descriptionRefs)a.value!==e.descriptionRefs.arr[e.descriptionRefs.idx]&&(e.descriptionRefs.arr[e.descriptionRefs.idx]=a.value,n=!0);else if("list"==a.propType){let e=[];for(let t=0;t<a.querySelectorAll("select").length;t++)e.push({name:a.querySelectorAll("select")[t].value,la:a.querySelectorAll("select")[t].refInput.value});t[a.getAttribute("property")]!=e&&(t[a.getAttribute("property")]=e,n=!0),console.log(e)}else t[a.getAttribute("property")]!==a.value&&(n=!0),t[a.getAttribute("property")]=a.value}),document.getElementById("newImgPreview")){let a="";a=e.descriptionRefs?e.descriptionRefs.arr[e.descriptionRefs.idx].toLowerCase():t.NOME,data.img[document.getElementById("selectListToEdit").value][a]?data.img[document.getElementById("selectListToEdit").value][a]!=document.getElementById("newImgPreview").src&&(data.img[document.getElementById("selectListToEdit").value][a]=document.getElementById("newImgPreview").src,n=!0):(data.img[document.getElementById("selectListToEdit").value][a]=document.getElementById("newImgPreview").src,n=!0)}return n}function itemFilters(){let e=document.createElement("div");e.className="filterList";let t=document.createElement("div"),n=document.createElement("div"),a=document.createElement("div"),l=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),i=document.createElement("div"),o={categoria:[""],rarita:[""],raggio:[""],mani:[""],tipo_danno:[""]};data.items.forEach(function(e){e.CATEGORIA&&(o.categoria.includes(e.CATEGORIA)||o.categoria.push(e.CATEGORIA)),e.RARITA&&(o.rarita.includes(e.RARITA)||o.rarita.push(e.RARITA)),e.RAGGIO&&(o.raggio.includes(e.RAGGIO)||o.raggio.push(e.RAGGIO)),e.MANI&&(o.mani.includes(e.MANI)||o.mani.push(e.MANI)),e.TIPO_DANNO&&(o.tipo_danno.includes(e.TIPO_DANNO)||o.tipo_danno.push(e.TIPO_DANNO))}),t.innerHTML="<span style='margin-right:1em;'>"+lang[currentLanguage][222]+"</span>";let d=document.createElement("input");d.id="itemFilterName",d.type="text",d.addEventListener("keyup",applyItemFilter),t.appendChild(d),n.innerHTML="<span style='margin-right:1em;'>"+lang[currentLanguage][223]+"</span>";let s=document.createElement("select");s.id="itemFilterCategory",o.categoria.forEach(function(e){let t=document.createElement("option");t.value=e,t.text=e,s.appendChild(t)}),s.addEventListener("change",applyItemFilter),n.appendChild(s),a.innerHTML="<span style='margin-right:1em;'>"+lang[currentLanguage][224]+"</span>";let u=document.createElement("select");u.id="itemFilterRarity",o.rarita.forEach(function(e){let t=document.createElement("option");t.value=e,t.text=e,u.appendChild(t)}),u.addEventListener("change",applyItemFilter),a.appendChild(u),l.innerHTML="<span style='margin-right:1em;'>"+lang[currentLanguage][225]+"</span>";let m=document.createElement("select");m.id="itemFilterRange",o.raggio.forEach(function(e){let t=document.createElement("option");t.value=e,t.text=e,m.appendChild(t)}),m.addEventListener("change",applyItemFilter),l.appendChild(m),r.innerHTML="<span style='margin-right:1em;'>"+lang[currentLanguage][226]+"</span>";let g=document.createElement("input");g.id="itemFilterMartial",g.type="checkbox",g.addEventListener("change",applyItemFilter),r.appendChild(g),c.innerHTML="<span style='margin-right:1em;'>"+lang[currentLanguage][227]+"</span>";let p=document.createElement("select");p.id="itemFilterHands",o.mani.forEach(function(e){let t=document.createElement("option");t.value=e,t.text=e,p.appendChild(t)}),p.addEventListener("change",applyItemFilter),c.appendChild(p),i.innerHTML="<span style='margin-right:1em;'>"+lang[currentLanguage][228]+"</span>";let h=document.createElement("select");h.id="itemFilterDmgType",o.tipo_danno.forEach(function(e){let t=document.createElement("option");t.value=e,t.text=e,h.appendChild(t)}),h.addEventListener("change",applyItemFilter),i.appendChild(h),e.appendChild(t),e.appendChild(n),e.appendChild(a),e.appendChild(l),e.appendChild(r),e.appendChild(c),e.appendChild(i);let y=document.getElementById("availableItems");if(y.firstChild){let t=y.firstChild;y.insertBefore(e,t),y.removeChild(t)}else y.appendChild(e)}function applyItemFilter(e){let t=document.getElementById("availableItems").querySelectorAll("[nome]"),n={};n.nome=document.getElementById("itemFilterName").value,n.categoria=document.getElementById("itemFilterCategory").value,n.rarita=document.getElementById("itemFilterRarity").value,n.raggio=document.getElementById("itemFilterRange").value,n.marziale=document.getElementById("itemFilterMartial").checked,n.mani=document.getElementById("itemFilterHands").value,n.tipo_danno=document.getElementById("itemFilterDmgType").value;for(let e of t){let t=1;Object.keys(n).forEach(function(a){let l=null,r=n[a];l=e.getAttribute(a)?e.getAttribute(a).toLowerCase():"","string"==typeof r?l.indexOf(r.toLowerCase())>=0?t*=1:t*=0:"boolean"==typeof r&&(t*=r?l==(r?"m":"")?1:0:1)}),1==t?e.classList.contains("hidden")&&e.classList.remove("hidden"):e.classList.add("hidden")}let a=document.getElementById("availableItems").querySelectorAll("[categoryWrapper='item']");for(let e=0;e<a.length;e++)a[e].querySelectorAll(".hidden[nome]").length==a[e].querySelectorAll("[nome]").length?a[e].classList.add("hidden"):a[e].classList.contains("hidden")&&a[e].classList.remove("hidden")}function setupClock(e={}){let t=e;null==t.description&&(t.description=""!=document.getElementById("clockDescription").value.trim()?document.getElementById("clockDescription").value.trim():null);let n=createNewClock(t);if(t.editable||null==t.editable){let e=fetchSvgIcon("times");e.style.position="absolute",e.style.top="0",e.style.right="0",e.addEventListener("click",()=>{clockList.splice(clockList.indexOf(n),1),updateClocks()}),n.appendChild(e)}return clockList.push(n),document.getElementById("clockDescription").value="",updateClocks(),n}function updateClocks(){document.getElementById("clockList").innerHTML="";for(let e=0;e<clockList.length;e++)document.getElementById("clockList").appendChild(clockList[e]);shareClocks()}function getClockParamList(){let e=[];for(let t=0;t<clockList.length;t++){let n={};null!=typeof clockList[t].clock.value&&(n.value=clockList[t].clock.value),null!=typeof clockList[t].clock.max&&(n.max=clockList[t].clock.max),null!=typeof clockList[t].clock.color&&(n.color=clockList[t].clock.color),null!=typeof clockList[t].clock.description&&(n.description=clockList[t].clock.description),null!=typeof clockList[t].clock.size&&(n.size=clockList[t].clock.size),n.editable=!1,e.push(n)}return e}function clockPattern(e,t=150){let n=t/1.5,a="M "+n+" "+n,l=2*Math.PI/e;for(let t=0;t<e;t++)a+=" L "+(Math.round(1e3*Math.cos(l*t))/1e3*n+n)+" "+(Math.round(1e3*Math.sin(l*t))/1e3*n+n)+" L "+n+" "+n;let r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.classList.add("clockGrid"),r.style.height=2*n+"px",r.style.width=2*n+"px",r.setAttribute("viewbox","0 0 "+2*n+" "+2*n),r.setAttribute("xmlns","http://www.w3.org/2000/svg");let c=document.createElementNS("http://www.w3.org/2000/svg","path");return c.setAttribute("stroke","black"),c.setAttribute("stroke-width","1"),c.setAttribute("d",a),r.appendChild(c),r}function createNewClock(e={},t=null){let n=document.createElement("div");n.value=null==e.value?"0":e.value,n.max=null==e.max?"4":e.max,n.color=null==e.color?"orange":e.color,n.description=e.description,n.size=null==e.size?150:Number(e.size.toString().match(/\d+/g)),n.editable=null==e.editable||e.editable,n.setValue=null==e.setValue||e.setValue,n.setMax=null==e.setMax||e.setMax,n.className="clock",n.style.cssText="--p:"+n.value+";--s:"+n.max+";--c:"+n.color+";--w:"+n.size+"px;";let a=clockPattern(n.max,n.size);n.prepend(a),n.grid=a;let l=document.createElement("span");n.appendChild(l),n.label=l;let r=document.createElement("div");r.className="clockWrapper",r.appendChild(n),r.clock=n;let c=document.createElement("div");c.setAttribute("controls",!0),n.editable&&r.appendChild(c);let i=document.createElement("input"),o=document.createElement("input");i.type="number",o.type="number",i.min="0",o.min="4",i.max=n.max,o.max="12",i.value=n.value,o.value=n.max,i.addEventListener("change",()=>{""==i.value&&(i.value=0),n.updateClock(i.value)}),o.addEventListener("change",()=>{""==o.value&&(o.value=0),i.max=o.value,Number(i.value)>Number(o.value)&&(i.value=o.value,i.max=o.value),n.updateClock(i.value,o.value)});let d=document.createElement("span"),s=document.createElement("span");d.innerHTML=lang[currentLanguage][229],s.innerHTML=lang[currentLanguage][230];let u=document.createElement("div"),m=document.createElement("div"),g=fetchSvgIcon("minus"),p=fetchSvgIcon("plus"),h=g.cloneNode(!0),y=p.cloneNode(!0),f=document.createEvent("HTMLEvents");if(f.initEvent("change",!1,!0),g.addEventListener("click",()=>{i.value=Math.max(Number(i.min),Number(i.value)-1),i.dispatchEvent(f)}),p.addEventListener("click",()=>{i.value=Math.min(Number(i.max),Number(i.value)+1),i.dispatchEvent(f)}),h.addEventListener("click",()=>{o.value=Math.max(Number(o.min),Number(o.value)-1),o.dispatchEvent(f)}),y.addEventListener("click",()=>{o.value=Math.min(Number(o.max),Number(o.value)+1),o.dispatchEvent(f)}),n.setValue&&(c.appendChild(d),u.appendChild(g),u.appendChild(i),u.appendChild(p),c.appendChild(u)),n.setMax&&(c.appendChild(s),m.appendChild(h),m.appendChild(o),m.appendChild(y),c.appendChild(m)),n.valueInput=i,n.maxInput=o,null!=n.description){let e=document.createElement("div");e.innerHTML=n.description,e.setAttribute("description",!0),r.appendChild(e)}return n.editCssString=function(e,t){let a=n.style.cssText.replace(/ /gi,"").split(";");a[a.indexOf(a.find(e=>e.substr(0,3)===t))]=t+":"+e,n.style.cssText=a.join(";")},n.setclockValue=function(e=null,t=null){null!=t&&n.setMaxSlice(t);let a=null==e?Math.min(Number(n.value),Number(n.max)):e;n.editCssString(a,"--p"),n.value=a,l.innerHTML=a+"/"+n.max,n.checkMax()},n.setMaxSlice=function(e){if(null!==e){n.editCssString(e,"--s"),n.max=e;let t=clockPattern(n.max,n.size);n.removeChild(n.grid),n.prepend(t),n.grid=t,n.checkMax()}},n.checkMax=function(){Number(n.value)>=Number(n.max)?n.classList.add("clockFull"):n.classList.remove("clockFull")},n.updateClock=function(e=null,a=null){n.setclockValue(e,a),shareClocks(),null!=t&&t(n)},n.updateClock(),r}function zeroPowerClock(){return createNewClock({max:"6",description:null,value:characterInfo.zeroPowerProgress,setMax:!1},e=>{characterInfo.zeroPowerProgress=e.value})}function createTracker(e,t=!0,n=null){const a={fabula:{tag:lang[currentLanguage][231],icon_id:"book",icon_class:"falt",icon_src:"book-open",icon_fn:null},hp:{tag:lang[currentLanguage][232],icon_id:"heart",icon_class:"falt",icon_src:"heartbeat",icon_fn:e=>heal()},mp:{tag:lang[currentLanguage][233],icon_id:"mind",icon_class:"falt",icon_src:"brain",icon_fn:e=>refresh()},ip:{tag:lang[currentLanguage][234],icon_id:"ipIcon",icon_class:"falt",icon_src:"briefcase",icon_fn:null},clock:{tag:lang[currentLanguage][235],icon_id:"",icon_class:"falt",icon_src:"clock",icon_fn:null}};if(a[e]){let r=document.createElement("div");r.className="scoreTracker";let c=document.createElement("div");c.innerHTML=a[e].tag,r.appendChild(c);let i=document.createElement("div");i.style.display="flex",i.style.fontSize="2rem",i.style.lineHeight="100%";let o=fetchSvgIcon(a[e].icon_src);function l(e,t){"none"==t.style.display?(t.style.removeProperty("display"),e.style.display="none"):(t.style.display="none",e.style.removeProperty("display"))}o.id=a[e].icon_id,o.style.margin="auto",o.className=a[e].icon_class,o.addEventListener("click",a[e].icon_fn),i.appendChild(o);let d=document.createElement("div");d.id="tracker_"+e,d.style.margin="auto",d.crossRef=e,i.appendChild(d);let s=document.createElement("input");s.type="Number",s.min=0,s.id=e,s.style.display="none",i.appendChild(s);let u=null;void 0!==characterInfo[e]?u=characterInfo[e]:null!=n&&(u=n),r.viewer=d,r.input=s,r.refObj=u,d.innerHTML=u.current;let m=null,g=null;t&&(d.addEventListener("dblclick",()=>{l(d,s)}),s.value=r.refObj.current,s.addEventListener("change",e=>{refreshTracker(r,s.value)}),s.addEventListener("keydown",e=>{"Enter"!=e.code&&"NumpadEnter"!=e.code&&"Tab"!=e.code&&13!==e.keyCode||document.activeElement.blur()}),s.addEventListener("blur",()=>{l(d,s)}),s.addEventListener("dblclick",()=>{l(d,s)}),(g=document.createElement("div")).style.fontSize="1rem",g.style.cursor="pointer",g.style.userSelect="none",g.innerHTML="<",g.score=e,g.addEventListener("click",function(e){refreshTracker(r,r.refObj.current-1)}),g.addEventListener("mousedown",async function(e){for(keptPressed=!0,await sleep(500);keptPressed&&(refreshTracker(r,r.refObj.current-1),r.input.value!=Math.max(r.input.min,Number(r.input.value)-1));)await sleep(50)}),g.addEventListener("mouseup",function(e){keptPressed=!1}),g.addEventListener("contextmenu",e=>e.preventDefault()),g.setAttribute("preventContext",!0),i.prepend(g),(m=document.createElement("div")).style.fontSize="1rem",m.style.cursor="pointer",m.style.userSelect="none",m.innerHTML=">",m.score=e,m.addEventListener("click",function(e){refreshTracker(r,r.refObj.current+1)}),m.addEventListener("mousedown",async function(e){for(keptPressed=!0,await sleep(500);keptPressed&&(refreshTracker(r,r.refObj.current+1),r.input.value!=Math.min(r.input.max?r.input.max:1/0,Number(r.input.value)+1));)await sleep(50)}),m.addEventListener("mouseup",function(e){keptPressed=!1}),m.addEventListener("contextmenu",e=>e.preventDefault()),m.setAttribute("preventContext",!0),i.appendChild(m)),r.appendChild(i);let p=document.createElement("div");return p.style.fontSize="1rem",r.refObj.max&&(p.innerHTML="Max: "+(Number(r.refObj.max)+Number(r.refObj.mod)),t&&(s.max=Number(r.refObj.max)+Number(r.refObj.mod),p.title=lang[currentLanguage]["26t"],p.style.cursor="pointer",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center",p.addEventListener("dblclick",function(e){addMod(e.target,r.refObj)}))),r.appendChild(p),r.textForChat={get value(){let t="\n**"+a[e].tag+"**",n={};return n.target=document.getElementById(e),t+="\n"+lang[currentLanguage][236]+": "+n.target.value+(n.target.max?"/"+n.target.max:"")}},r.addEventListener("contextmenu",function(e){buildContextMenu(r,[e.clientX,e.clientY],{chatInter:!0}),e.preventDefault(e)}),r}return null}async function saveCharacter(e=!1){FUDB.chars.get(characterInfo.name,function(t){let n=!1;(n=!!e||window.confirm(lang[currentLanguage][237]))&&FUDB.chars.update({id:characterInfo.name,data:JSON.stringify(characterInfo)})},function(){FUDB.chars.add({id:characterInfo.name,data:JSON.stringify(characterInfo)}),updateListFromDB(document.getElementById("listOfChars"),"chars")})}async function loadCharacter(e){Object.keys(characterInfo).forEach(function(t){e.hasOwnProperty(t)&&(characterInfo[t]=e[t])}),void 0!==characterInfo.autosave&&(document.getElementById("autosaveFlag").checked=characterInfo.autosave),updateSheet()}async function deleteCharacter(){if(window.confirm(lang[currentLanguage][238])){let e=document.getElementById("listOfChars");if(e.value){let t=e.selectedIndex;FUDB.chars.delete(e.value,function(){e.remove(t)})}else console.log(lang[currentLanguage][239])}}async function download(){let e=new Blob([JSON.stringify(characterInfo)],{type:"text/plain"});if(console.log(JSON.stringify(characterInfo)),"undefined"!=typeof Capacitor&&void 0!==Capacitor.Plugins.Filesystem)return;let t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=characterInfo.name+".fabula",t.click()}function sanitizeString(e){return e.replace("<script","").replace("</script","").replace("<a","").replace("</a","").replace("onclick=","").replace("href=","")}async function fetchCharFromMemory(){let e=document.getElementById("listOfChars");e.value?FUDB.chars.get(e.value,function(e){console.log(lang[currentLanguage][240]);let t=sanitizeString(e.data);loadCharacter(JSON.parse(t)),console.log(lang[currentLanguage][241])},function(){console.log(lang[currentLanguage][242])}):console.log(lang[currentLanguage][243])}function upload(){if(this.files&&this.files[0]){var e=this.files[0],t=new FileReader;t.addEventListener("load",function(e){let t=sanitizeString(e.target.result);loadCharacter(JSON.parse(t)),document.getElementById("charLoader").value=""}),t.readAsText(e)}}async function saveDefaultLibrary(){if(document.getElementById("listOfLibraries").value){let e=document.getElementById("listOfLibraries").value;FUDB.chosenSet.get("default",function(t){FUDB.chosenSet.update({id:"default",data:e}),alert(lang[currentLanguage][254]+e+"."),console.log(lang[currentLanguage][255])},function(){FUDB.chosenSet.add({id:"default",data:e}),alert(lang[currentLanguage][254]+e+"."),console.log(lang[currentLanguage][256])})}}async function loadDefaultLibrary(){FUDB.chosenSet.get("default",function(e){document.getElementById("listOfLibraries").value=e.data,fetchLibraryFromMemory(e.data)},function(){console.log(lang[currentLanguage][257])})}function saveLibraryPrompt(){getLibrary().id=window.prompt(lang[currentLanguage][258],getLibrary().id),saveLibrary()}function getLibrary(){let e={};return e=void 0!==fullData.id?fullData:data}function setLibrary(e){void 0===e.maxLv?(fullData=e,data=e[currentLanguage]):(fullData={},data=e)}async function saveLibrary(){let e=getLibrary();e.hasOwnProperty("id")&&FUDB.libraries.get(e.id,function(t){window.confirm(lang[currentLanguage][237])&&(FUDB.libraries.update({id:e.id,data:JSON.stringify(e)}),setLibraryToBeSaved(!1))},function(){FUDB.libraries.add({id:e.id,data:JSON.stringify(e)}),updateListFromDB(document.getElementById("listOfLibraries"),"libraries"),setLibraryToBeSaved(!1)})}async function loadLibrary(e){setLibrary(e),addChatLine("Info",lang[currentLanguage][259]+e.id+"."),document.getElementById("curLibraryName").innerHTML="<b>"+e.id+"</b>",updateSheet()}async function deleteLibrary(){if(window.confirm(lang[currentLanguage][238])){let e=document.getElementById("listOfLibraries");if(e.value){let t=e.selectedIndex;FUDB.libraries.delete(e.value,function(){let n=getLibrary().id;FUDB.chosenSet.get("default",function(e){n==e.data&&FUDB.libraries.delete("default",function(){console.log(lang[currentLanguage][245])})},function(){}),n==e.value&&(setLibrary(defaultData),updateSheet()),e.remove(t)})}else console.log(lang[currentLanguage][261])}}function downloadLibrary(){let e=getLibrary();var t=document.createElement("a"),n=new Blob([JSON.stringify(e)],{type:"text/plain"});t.href=URL.createObjectURL(n),t.download=e.id+".fudb",t.click()}async function fetchLibraryFromMemory(e=null){e||(e=document.getElementById("listOfLibraries").value),null!=e?FUDB.libraries.get(e,function(e){console.log(lang[currentLanguage][240]),loadLibrary(JSON.parse(e.data)),itemFilters(),console.log(lang[currentLanguage][241]),populateEditorSelect(),"Annulla"==document.getElementById("confirmObjectToEdit").innerHTML&&document.getElementById("confirmObjectToEdit").click(),(characterInfo.inventory.length>0||characterInfo.skills.length>0)&&window.confirm(lang[currentLanguage][262])&&checkCharacterUpdate()},function(){console.log(lang[currentLanguage][263])}):console.log(lang[currentLanguage][263])}function checkCharacterUpdate(){let e=null;for(let t=0;t<characterInfo.inventory.length;t++){let n=characterInfo.inventory[t];(e=data.items.filter(e=>e.NOME===n.NOME)).length>0&&Object.keys(n).forEach(t=>{n[t]!==e[0][t]&&void 0!==n[t]&&void 0!==e[0][t]&&"object"!=typeof n[t]&&"object"!=typeof e[0][t]&&window.confirm(lang[currentLanguage][264]+"'"+e[0].NOME+"', "+lang[currentLanguage][265]+" '"+t+"': "+lang[currentLanguage][266]+" '"+n[t]+"', "+lang[currentLanguage][267]+" '"+e[0][t]+"'. "+lang[currentLanguage][268])&&(n[t]=e[0][t])})}for(let t=0;t<characterInfo.skills.length;t++){let n=characterInfo.skills[t];(e=data.abilities.filter(e=>e.NOME===n.NOME)).length>0&&Object.keys(n).forEach(t=>{n[t]!==e[0][t]&&void 0!==n[t]&&void 0!==e[0][t]&&"object"!=typeof n[t]&&"object"!=typeof e[0][t]&&window.confirm(lang[currentLanguage][264]+"'"+e[0].NOME+"', "+lang[currentLanguage][265]+" '"+t+"': "+lang[currentLanguage][266]+" '"+inv[t]+"', "+lang[currentLanguage][267]+" '"+e[0][t]+"'. "+lang[currentLanguage][268])&&(n[t]=e[0][t])})}updateSheet()}function uploadLibrary(){if(this.files&&this.files[0]){var e=this.files[0],t=new FileReader;t.addEventListener("load",function(e){setLibrary(JSON.parse(sanitizeString(e.target.result))),saveLibrary(),updateSheet(),document.getElementById("libraryLoader").value=""}),t.readAsText(e)}}function loadMod(){if(this.files&&this.files[0]){var e=this.files[0],t=new FileReader;t.addEventListener("load",function(e){let t=null;void 0!==document.getElementById("importedLib")&&null!=document.getElementById("importedLib")?t=document.getElementById("importedLib"):((t=document.createElement("script")).id="importedLib",document.getElementsByTagName("head")[0].appendChild(t)),t.innerHTML=e.target.result}),t.readAsText(e)}}function sleep(e){return new Promise(t=>setTimeout(t,e))}function encodeImage(e,t){var n=e.files[0],a=new FileReader;a.onloadend=function(){t(a.result)},a.readAsDataURL(n)}function refreshProfileImage(){if(characterInfo.hasOwnProperty("img")&&""!=characterInfo.img){let e=document.createElement("img");e.style.margin="0.5em",e.style.maxHeight="25em",e.style.maxWidth="var(-webkit-fill-available, -moz-available)",e.src=characterInfo.img,document.getElementById("profileImage").innerHTML="";let t=document.createElement("div"),n=fetchSvgIcon("times");n.style.width="3em",n.style.height="3em",t.appendChild(n),t.addEventListener("click",function(){characterInfo.img="",document.getElementById("profileImage").innerHTML=""}),t.className="popupMenu",e.textForChat={get value(){return e.outerHTML}},e.addEventListener("contextmenu",function(t){buildContextMenu(e,[t.clientX,t.clientY],{chatInter:!0}),t.preventDefault(t)}),document.getElementById("profileImage").appendChild(t),document.getElementById("profileImage").appendChild(e)}else document.getElementById("profileImage").innerHTML=""}function editPalette(e=characterInfo.sheetColor){let t=pSBC(0,e,"c"),n=pSBC(.5,e,"c"),a=pSBC(-.5,e,"c"),l=pSBC(-.9,e,"c"),r=null;(r=document.getElementById("FUSpecificStyle").sheet.cssRules)&&(r[0].style.backgroundColor=n,r[0].style.color=getBrightness(n)>125?"black":"white",r[1].style.backgroundColor=t,r[1].style.color=getBrightness(t)>125?"black":"white",r[2].style.backgroundColor=a,r[2].style.color=getBrightness(a)>125?"black":"white",r[3].style.borderColor=l,r[4].style.filter=getBrightness(n)>125?"brightness(0) saturate(100%)":"invert(100%)",r[5].style.filter=getBrightness(t)>125?"brightness(0) saturate(100%)":"invert(100%)",r[6].style.filter=getBrightness(a)>125?"brightness(0) saturate(100%)":"invert(100%)")}function getBrightness(e){let t=e.split("(")[1].split(")")[0].split(",");return Math.round((299*t[0]+587*t[1]+114*t[2])/1e3)}const pSBC=(e,t,n,a)=>{let l,r,c,i,o,d,s,u=parseInt,m=Math.round,g="string"==typeof n;return"number"!=typeof e||e<-1||e>1||"string"!=typeof t||"r"!=t[0]&&"#"!=t[0]||n&&!g?null:(this.pSBCr||(this.pSBCr=(e=>{let t=e.length,n={};if(t>9){if([l,r,c,g]=e=e.split(","),(t=e.length)<3||t>4)return null;n.r=u("a"==l[3]?l.slice(5):l.slice(4)),n.g=u(r),n.b=u(c),n.a=g?parseFloat(g):-1}else{if(8==t||6==t||t<4)return null;t<6&&(e="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+(t>4?e[4]+e[4]:"")),e=u(e.slice(1),16),9==t||5==t?(n.r=e>>24&255,n.g=e>>16&255,n.b=e>>8&255,n.a=m((255&e)/.255)/1e3):(n.r=e>>16,n.g=e>>8&255,n.b=255&e,n.a=-1)}return n})),s=t.length>9,s=g?n.length>9||"c"==n&&!s:s,o=this.pSBCr(t),i=e<0,d=n&&"c"!=n?this.pSBCr(n):i?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},i=1-(e=i?-1*e:e),o&&d?(a?(l=m(i*o.r+e*d.r),r=m(i*o.g+e*d.g),c=m(i*o.b+e*d.b)):(l=m((i*o.r**2+e*d.r**2)**.5),r=m((i*o.g**2+e*d.g**2)**.5),c=m((i*o.b**2+e*d.b**2)**.5)),g=o.a,d=d.a,g=(o=g>=0||d>=0)?g<0?d:d<0?g:g*i+d*e:0,s?"rgb"+(o?"a(":"(")+l+","+r+","+c+(o?","+m(1e3*g)/1e3:"")+")":"#"+(4294967296+16777216*l+65536*r+256*c+(o?m(255*g):0)).toString(16).slice(1,o?void 0:-2)):null)};function encodeHTML(e){return e.replace(/[\u00A0-\u9999\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"})}function getElementByFUId(e){return document.querySelectorAll("[fuid='"+e+"']")[0]}function fetchMemoryData(){let e=document.getElementById("listOfChars"),t=document.getElementById("listOfLibraries");updateListFromDB(e,"chars"),updateListFromDB(t,"libraries")}function updateListFromDB(e,t){FUDB[t].keys(function(t){populateSelect(e,t)})}function populateSelect(e,t){t.length>0&&(e.innerHTML="",t.forEach(function(t,n){let a=document.createElement("option");void 0!==t.NOME?(a.refObj=t,a.value=t.NOME,a.text=t.NOME):(a.value=t,a.text=t),e.appendChild(a)}))}function populateEditorSelect(){if(!data[document.getElementById("selectListToEdit").value]){if(!data.editorTags[document.getElementById("selectListToEdit").value.toUpperCase()])return!1;{let e={};Object.keys(data.editorTags[document.getElementById("selectListToEdit").value.toUpperCase()]).forEach(t=>{e[t]="NOME"===t?lang[currentLanguage][244]:""}),data[document.getElementById("selectListToEdit").value]=[e]}}data[document.getElementById("selectListToEdit").value].length>0&&(document.getElementById("listToEdit").innerHTML="",data[document.getElementById("selectListToEdit").value].forEach(function(e,t){let n=document.createElement("option");void 0!==e.NOME?(n.value=e.NOME,n.text=e.NOME,n.refObj=e):(n.value=e,n.text=e,n.refObj={arr:data[document.getElementById("selectListToEdit").value],idx:t,NOME:e.toLowerCase()}),document.getElementById("listToEdit").appendChild(n)}))}function setLibraryToBeSaved(e){e?(document.getElementById("curLibraryName").innerHTML="<b style='color:red;'>"+getLibrary().id+" - "+lang[currentLanguage][246]+"</b>",document.getElementById("saveLib").style.removeProperty("display")):(document.getElementById("curLibraryName").innerHTML="<b>"+getLibrary().id+"</b>",document.getElementById("saveLib").style.display="none")}function selectToolkitMode(e){let t=document.getElementById("FUToolkit").querySelectorAll("[modeSelector]");"charSheet"==e?(document.getElementById("selectCharacterMode").setAttribute("selected","true"),document.getElementById("selectLibraryMode").removeAttribute("selected")):"library"==e&&(document.getElementById("selectCharacterMode").removeAttribute("selected"),document.getElementById("selectLibraryMode").setAttribute("selected","true"));for(let n=0;n<t.length;n++){let a=!1;t[n].getAttribute("modeSelector")==e&&(a=!0),a?t[n].style.removeProperty("display"):t[n].style.display="none"}}function progressiveNaming(e,t){let n=0,a="",l="";return e.endsWith(")")&&e.lastIndexOf("(")>-1&&(a=e.substring(e.lastIndexOf("(")),n=Number(a.substring(1,a.length-1))),l=""==a?e+" ("+(n+1)+")":e.replace(a,"("+(n+1)+")"),t.includes(l)&&(l=progressiveNaming(l,t)),l}function showLobby(e){"join"==e?(document.getElementById("lobbyCreator").disabled=!1,document.getElementById("lobbyUser").disabled=!0,document.getElementById("lobbyJoin").style.removeProperty("display"),document.getElementById("lobbyMake").style.display="none"):"make"==e&&(document.getElementById("lobbyCreator").disabled=!0,document.getElementById("lobbyUser").disabled=!1,document.getElementById("lobbyMake").style.removeProperty("display"),document.getElementById("lobbyJoin").style.display="none")}function disableLobbySelector(){let e=document.getElementById("lobbyCreator"),t=document.getElementById("lobbyUser"),n=document.getElementById("lobbyName"),a=document.getElementById("userName"),l=document.getElementById("connect"),r=document.getElementById("disconnect"),c=document.getElementById("startLobby"),i=document.getElementById("idLobby");null!=p2p.peer?(e.disabled=!0,t.disabled=!0,n.disabled=!0,a.disabled=!0,l.disabled=!0,r.disabled=!1,c.disabled=!0,i.disabled=!0,document.getElementById("charSharer").style.removeProperty("display"),document.getElementById("libSharer").style.removeProperty("display")):(e.disabled=!1,t.disabled=!1,n.disabled=!1,a.disabled=!1,l.disabled=!1,r.disabled=!0,c.disabled=!1,i.disabled=!1,document.getElementById("charSharer").style.display="none",document.getElementById("libSharer").style.display="none",document.getElementById("usListChar").innerHTML="",document.getElementById("usListLib").innerHTML="")}function sendMessage(e=null,t=null){let n="";""!=(n=null===e?document.getElementById("msgToSend").value.trim():e.toString())&&(null==p2p.peer?addChatLine("I",n):broadcastMessage(n)),document.getElementById("msgToSend").value="",document.getElementById("msgToSend").focus()}function addChatLine(e,t){if(""!=t){let n=document.createElement("span");if(n.innerHTML="<b>"+e+"</b>: "+t.toString(),n.className="chatLine",document.getElementById("chatLog").appendChild(n),document.getElementById("chatLog").scrollTo(0,document.getElementById("chatLog").scrollHeight),"string"==typeof t||t instanceof String){if("/r "===t.substring(0,3).toLowerCase()&&(null==p2p.peer||null!=p2p.peer&&p2p.master)){let n=rollEngine(e,t),a=n.listOfRolls,l=document.createElement("span");l.className="chatLine";let r=l.cloneNode(!0),c=l.cloneNode(!0),i=l.cloneNode(!0);if(r.innerHTML=a,c.innerHTML="Rolled a "+n.total+"!",2==n.rolls.filter(e=>null!=e.max).length&&2==n.rolls.filter(e=>e.value==n.rolls.reduce((e,t)=>e+t.value,0)/2).length){let t="";2==n.rolls.filter(e=>e.value>=6).length?t="<span style='color:green;'>["+e+"] "+lang[currentLanguage][246]+"</span>":2==n.rolls.filter(e=>1==e.value).length?t="<span style='color:red;'>["+e+"] "+lang[currentLanguage][247]+"</span>":hasAbility(characterInfo,lang[currentLanguage][249])&&(t="<span style='color:lime;'>["+e+"] "+lang[currentLanguage][248]+"</span>"),broadcastMessage(t,"RollEngine"),i.innerHTML=t}waitForCallback>0&&(document.getElementById("rollResult").appendChild(r),document.getElementById("rollResult").appendChild(c),document.getElementById("rollResult").appendChild(i),waitForCallback=0)}waitForCallback>0&&n.innerHTML.search(">"+p2p.userName+"<")>-1&&"RollEngine"==e&&(document.getElementById("rollResult").appendChild(n.cloneNode(!0)),waitForCallback--)}return"none"==document.getElementById("FUChat").style.display&&document.getElementById("openChat").classList.add("chatNotification"),n}return null}function randomInt(e){return Math.floor(Math.random()*e)+1}function rollEngine(e,t){let n=rollDice(t);n.listOfRolls="";for(let e=0;e<n.rolls.length;e++)""!=n.listOfRolls&&(n.rolls[e].positive?n.listOfRolls+=" + ":n.listOfRolls+=" - "),n.listOfRolls+=n.rolls[e].value+(n.rolls[e].max?"(d"+n.rolls[e].max+")":"");return broadcastMessage("["+e+"] "+n.listOfRolls,"RollEngine"),broadcastMessage("["+e+"]  rolled a "+n.total+"!","RollEngine"),n}function rollDice(e){let t={rolls:[],total:0},n=e.substring(3).trim().replace(/  |\t\r\n|\n|\r/gm,"").toLowerCase(),a=!1,l="0",r="",c={value:0,positive:!0,max:null},i=!0;for(let e=0;e<n.length;e++){let o=n.charAt(e);if(isNaN(parseInt(o))||(a?r=r.concat(o):l=l.concat(o)),"d"===o&&(a=!0),"+"===o||"-"===o||e==n.length-1){let n=null,d=1;if(a&&(d=Math.max(1,parseInt(l))),e>0){for(let e=0;e<d;e++)n=JSON.parse(JSON.stringify(c)),a?(n.value=randomInt(parseInt(r)),n.positive=!0,n.max=parseInt(r)):(n.value=parseInt(l),n.positive=i),n.positive?t.total+=n.value:t.total-=n.value,t.rolls.push(n);l="0",r="",a=!1}"+"===o?i=!0:"-"===o&&(i=!1)}}return t}function changeLanguage(e){FUDB.lang.update({id:"0",data:e}).onsuccess=(()=>{refreshLang(e),void 0!==fullData.id&&(data=fullData[currentLanguage]),populateEditorSelect(),updateSheet()})}function refreshLang(e){let t=document.querySelectorAll("[langtag]"),n="",a="";currentLanguage=e;for(let l=0;l<t.length;l++)n=t[l].getAttribute("langtag"),""!=(a=lang[e][n])&&(t[l].innerHTML=a),void 0!==t[l].getAttribute("title")&&void 0!==lang[e][n+"t"]&&t[l].setAttribute("title",lang[e][n+"t"]);document.getElementById("languagesMenu").value=e}function setupLang(){document.getElementById("languages").addEventListener("change",e=>{refreshLang(e.target.value)}),document.getElementById("langChoser").style.removeProperty("display"),document.getElementById("EULA").style.display="none",document.getElementById("startup").style.display="none",FUDB.open(()=>{FUDB.lang.get("0",e=>{document.getElementById("langChoser").style.display="none",refreshLang(e.data),setupEULA()},()=>{document.getElementById("langChoser").firstElementChild.style.removeProperty("display")})})}function selectLang(e="languages"){document.getElementById("langChoser").style.display="none";let t=document.getElementById(e).value;FUDB.lang.add({id:"0",data:t}).onsuccess=(()=>{refreshLang(t),setupEULA()})}function setupEULA(){document.getElementById("EULA").style.removeProperty("display"),document.getElementById("langChoser").style.display="none",document.getElementById("startup").style.display="none",FUDB.open(()=>{FUDB.EULA.get("0",()=>{console.log(lang[currentLanguage][252]),document.getElementById("EULA").style.display="none",startUp()},()=>{console.log(lang[currentLanguage][251]),document.getElementById("EULA").firstElementChild.style.removeProperty("display")})})}function acceptEULA(){FUDB.EULA.add({id:"0",data:"1"}).onsuccess=(()=>{console.log(lang[currentLanguage][253]),setupEULA()})}function closeModalWithBack(){"none"!=document.getElementById("modalBckgr").style.display&&setModal()}function startUp(){loadDefaultLibrary(),fetchMemoryData(),document.querySelectorAll("link[rel='icon']")[0].setAttribute("href",fallbackImgB64),setLibrary(defaultData),startUpCharacter(),itemFilters(),setupEvents(),document.getElementById("openClocks").style.removeProperty("display"),document.getElementById("openLobby").style.removeProperty("display"),document.getElementById("openChat").style.removeProperty("display"),"undefined"!=typeof Capacitor&&(void 0!==Capacitor.Plugins.App&&(Capacitor.Plugins.App.addListener("backButton",closeModalWithBack),Capacitor.Plugins.App.addListener("appUrlOpen",e=>{const t=e.url.split(domain)[1];p2p.master||(document.getElementById("idLobby").value=t,joinLobby())})),void 0!==Capacitor.Plugins.Filesystem&&(document.getElementById("exportChar").style.display="none",document.getElementById("exportLib").style.display="none")),document.addEventListener("keydown",function(e){let t=!1;void 0!==typeof e.target&&("INPUT"!=e.target.nodeName&&"TEXTAREA"!=e.target.nodeName&&"true"!=e.target.getAttribute("contenteditable")||(t=!0)),8!=e.keyCode||t||(e.preventDefault(),closeModalWithBack())})}