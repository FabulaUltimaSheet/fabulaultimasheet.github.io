'use strict';

const randomNames=["Smith","Johnson","Williams","Brown","Jones","Miller","Davis","Garcia","Rodriguez","Wilson","Martinez","Anderson","Taylor","Thomas","Hernandez","Moore","Martin","Jackson","Thompson","White","Lopez","Lee","Gonzalez","Harris","Clark","Lewis","Robinson","Walker","Perez","Hall","Young","Allen","Sanchez","Wright","King","Scott","Green","Baker","Adams","Nelson","Hill","Ramirez","Campbell","Mitchell","Roberts","Carter","Phillips","Evans","Turner","Torres","Parker","Collins","Edwards","Stewart","Flores","Morris","Nguyen","Murphy","Rivera","Cook","Rogers","Morgan","Peterson","Cooper","Reed","Bailey","Bell","Gomez","Kelly","Howard","Ward","Cox","Diaz","Richardson","Wood","Watson","Brooks","Bennett","Gray","James","Reyes","Cruz","Hughes","Price","Myers","Long","Foster","Sanders","Ross","Morales","Powell","Sullivan","Russell","Ortiz","Jenkins","Gutierrez","Perry","Butler","Barnes","Fisher","Henderson","Coleman","Simmons","Patterson","Jordan","Reynolds","Hamilton","Graham","Kim","Gonzales","Alexander","Ramos","Wallace","Griffin","West","Cole","Hayes","Chavez","Gibson","Bryant","Ellis","Stevens","Murray","Ford","Marshall","Owens","Mcdonald","Harrison","Ruiz","Kennedy","Wells","Alvarez","Woods","Mendoza","Castillo","Olson","Webb","Washington","Tucker","Freeman","Burns","Henry","Vasquez","Snyder","Simpson","Crawford","Jimenez","Porter","Mason","Shaw","Gordon","Wagner","Hunter","Romero","Hicks","Dixon","Hunt","Palmer","Robertson","Black","Holmes","Stone","Meyer","Boyd","Mills","Warren","Fox","Rose","Rice","Moreno","Schmidt","Patel","Ferguson","Nichols","Herrera","Medina","Ryan","Fernandez","Weaver","Daniels","Stephens","Gardner","Payne","Kelley","Dunn","Pierce","Arnold","Tran","Spencer","Peters","Hawkins","Grant","Hansen","Castro","Hoffman","Hart","Elliott","Cunningham","Knight","Bradley","Carroll","Hudson","Duncan","Armstrong","Berry","Andrews","Johnston","Ray","Lane","Riley","Carpenter","Perkins","Aguilar","Silva","Richards","Willis","Matthews","Chapman","Lawrence","Garza","Vargas","Watkins","Wheeler","Larson","Carlson","Harper","George","Greene","Burke","Guzman","Morrison","Munoz","Jacobs","Obrien","Lawson","Franklin","Lynch","Bishop","Carr","Salazar","Austin","Mendez","Gilbert","Jensen","Williamson","Montgomery","Harvey","Oliver","Howell","Dean","Hanson","Weber","Garrett","Sims","Burton","Fuller","Soto","Mccoy","Welch","Chen","Schultz","Walters","Reid","Fields","Walsh","Little","Fowler","Bowman","Davidson","May","Day","Schneider","Newman","Brewer","Lucas","Holland","Wong","Banks","Santos","Curtis","Pearson","Delgado","Valdez","Pena","Rios","Douglas","Sandoval","Barrett","Hopkins","Keller","Guerrero","Stanley","Bates","Alvarado","Beck","Ortega","Wade","Estrada","Contreras","Barnett","Caldwell","Santiago","Lambert","Powers","Chambers","Nunez","Craig","Leonard","Lowe","Rhodes","Byrd","Gregory","Shelton","Frazier","Becker","Maldonado","Fleming","Vega","Sutton","Cohen","Jennings","Parks","Mcdaniel","Watts","Barker","Norris","Vaughn","Vazquez","Holt","Schwartz","Steele","Benson","Neal","Dominguez","Horton","Terry","Wolfe","Hale","Lyons","Graves","Haynes","Miles","Park","Warner","Padilla","Bush","Thornton","Mccarthy","Mann","Zimmerman","Erickson","Fletcher","Mckinney","Page","Dawson","Joseph","Marquez","Reeves","Klein","Espinoza","Baldwin","Moran","Love","Robbins","Higgins","Ball","Cortez","Le","Griffith","Bowen","Sharp","Cummings","Ramsey","Hardy","Swanson","Barber","Acosta","Luna","Chandler","Blair","Daniel","Cross","Simon","Dennis","Oconnor","Quinn","Gross","Navarro","Moss","Fitzgerald","Doyle","Mclaughlin","Rojas","Rodgers","Stevenson","Singh","Yang","Figueroa","Harmon","Newton","Paul","Manning","Garner","Mcgee","Reese","Francis","Burgess","Adkins","Goodman","Curry","Brady","Christensen","Potter","Walton","Goodwin","Mullins","Molina","Webster","Fischer","Campos","Avila","Sherman","Todd","Chang","Blake","Malone","Wolf","Hodges","Juarez","Gill","Farmer","Hines","Gallagher","Duran","Hubbard","Cannon","Miranda","Wang","Saunders","Tate","Mack","Hammond","Carrillo","Townsend","Wise","Ingram","Barton","Mejia","Ayala","Schroeder","Hampton","Rowe","Parsons","Frank","Waters","Strickland","Osborne","Maxwell","Chan","Deleon","Norman","Harrington","Casey","Patton","Logan","Bowers","Mueller","Glover","Floyd","Hartman","Buchanan","Cobb","French","Kramer","Mccormick","Clarke","Tyler","Gibbs","Moody","Conner","Sparks","Mcguire","Leon","Bauer","Norton","Pope","Flynn","Hogan","Robles","Salinas","Yates","Lindsey","Lloyd","Marsh","Mcbride","Owen","Solis","Pham","Lang","Pratt","Lara","Brock","Ballard","Trujillo","Shaffer","Drake","Roman","Aguirre","Morton","Stokes","Lamb","Pacheco","Patrick","Cochran","Shepherd","Cain","Burnett","Hess","Li","Cervantes","Olsen","Briggs","Ochoa","Cabrera","Velasquez","Montoya","Roth","Meyers","Cardenas","Fuentes","Weiss","Hoover","Wilkins","Nicholson","Underwood","Short","Carson","Morrow","Colon","Holloway","Summers","Bryan","Petersen","Mckenzie","Serrano","Wilcox","Carey","Clayton","Poole","Calderon","Gallegos","Greer","Rivas","Guerra","Decker","Collier","Wall","Whitaker","Bass","Flowers","Davenport","Conley","Houston","Huff","Copeland","Hood","Monroe","Massey","Roberson","Combs","Franco","Larsen","Pittman","Randall","Skinner","Wilkinson","Kirby","Cameron","Bridges","Anthony","Richard","Kirk","Bruce","Singleton","Mathis","Bradford","Boone","Abbott","Charles","Allison","Sweeney","Atkinson","Horn","Jefferson","Rosales","York","Christian","Phelps","Farrell","Castaneda","Nash","Dickerson","Bond","Wyatt","Foley","Chase","Gates","Vincent","Mathews","Hodge","Garrison","Trevino","Villarreal","Heath","Dalton","Valencia","Callahan","Hensley","Atkins","Huffman","Roy","Boyer","Shields","Lin","Hancock","Grimes","Glenn","Cline","Delacruz","Camacho","Dillon","Parrish","Oneill","Melton","Booth","Kane","Berg","Harrell","Pitts","Savage","Wiggins","Brennan","Salas","Marks","Russo","Sawyer","Baxter","Golden","Hutchinson","Liu","Walter","Mcdowell","Wiley","Rich","Humphrey","Johns","Koch","Suarez","Hobbs","Beard","Gilmore","Ibarra","Keith","Macias","Khan","Andrade","Ware","Stephenson","Henson","Wilkerson","Dyer","Mcclure","Blackwell","Mercado","Tanner","Eaton","Clay","Barron","Beasley","Oneal","Preston","Small","Wu","Zamora","Macdonald","Vance","Snow","Mcclain","Stafford","Orozco","Barry","English","Shannon","Kline","Jacobson","Woodard","Huang","Kemp","Mosley","Prince","Merritt","Hurst","Villanueva","Roach","Nolan","Lam","Yoder","Mccullough","Lester","Santana","Valenzuela","Winters","Barrera","Leach","Orr","Berger","Mckee","Strong","Conway","Stein","Whitehead","Bullock","Escobar","Knox","Meadows","Solomon","Velez","Odonnell","Kerr","Stout","Blankenship","Browning","Kent","Lozano","Bartlett","Pruitt","Buck","Barr","Gaines","Durham","Gentry","Mcintyre","Sloan","Melendez","Rocha","Herman","Sexton","Moon","Hendricks","Rangel","Stark","Lowery","Hardin","Hull","Sellers","Ellison","Calhoun","Gillespie","Mora","Knapp","Mccall","Morse","Dorsey","Weeks","Nielsen","Livingston","Leblanc","Mclean","Bradshaw","Glass","Middleton","Buckley","Schaefer","Frost","Howe","House","Mcintosh","Ho","Pennington","Reilly","Hebert","Mcfarland","Hickman","Noble","Spears","Conrad","Arias","Galvan","Velazquez","Huynh","Frederick","Randolph","Cantu","Fitzpatrick","Mahoney","Peck","Villa","Michael","Donovan","Mcconnell","Walls","Boyle","Mayer","Zuniga","Giles","Pineda","Pace","Hurley","Mays","Mcmillan","Crosby","Ayers","Case","Bentley","Shepard","Everett","Pugh","David","Mcmahon","Dunlap","Bender","Hahn","Harding","Acevedo","Raymond","Blackburn","Duffy","Landry","Dougherty","Bautista","Shah","Potts","Arroyo","Valentine","Meza","Gould","Vaughan","Fry","Rush","Avery","Herring","Dodson","Clements","Sampson","Tapia","Bean","Lynn","Crane","Farley","Cisneros","Benton","Ashley","Mckay","Finley","Best","Blevins","Friedman","Moses","Sosa","Blanchard","Huber","Frye","Krueger","Bernard","Rosario","Rubio","Mullen","Benjamin","Haley","Chung","Moyer","Choi","Horne","Yu","Woodward","Ali","Nixon","Hayden","Rivers","Estes","Mccarty","Richmond","Stuart","Maynard","Brandt","Oconnell","Hanna","Sanford","Sheppard","Church","Burch","Levy","Rasmussen","Coffey","Ponce","Faulkner","Donaldson","Schmitt","Novak","Costa","Montes","Booker","Cordova","Waller","Arellano","Maddox","Mata","Bonilla","Stanton","Compton","Kaufman","Dudley","Mcpherson","Beltran","Dickson","Mccann","Villegas","Proctor","Hester","Cantrell","Daugherty","Cherry","Bray","Davila","Rowland","Levine","Madden","Spence","Good","Irwin","Werner","Krause","Petty","Whitney","Baird","Hooper","Pollard","Zavala","Jarvis","Holden","Haas","Hendrix","Mcgrath","Bird","Lucero","Terrell","Riggs","Joyce","Mercer","Rollins","Galloway","Duke","Odom","Andersen","Downs","Hatfield","Benitez","Archer","Huerta","Travis","Mcneil","Hinton","Zhang","Hays","Mayo","Fritz","Branch","Mooney","Ewing","Ritter","Esparza","Frey","Braun","Gay","Riddle","Haney","Kaiser","Holder","Chaney","Mcknight","Gamble","Vang","Cooley","Carney","Cowan","Forbes","Ferrell","Davies","Barajas","Shea","Osborn","Bright","Cuevas","Bolton","Murillo","Lutz","Duarte","Kidd","Key","Cooke"]

const lobbyNames=["Emma","Isabella","Emily","Madison","Ava","Olivia","Sophia","Abigail","Elizabeth","Chloe","Samantha","Addison","Natalie","Mia","Alexis","Alyssa","Hannah","Ashley","Ella","Sarah","Grace","Taylor","Brianna","Lily","Hailey","Anna","Victoria","Kayla","Lillian","Lauren","Kaylee","Allison","Savannah","Nevaeh","Gabriella","Sofia","Makayla","Avery","Riley","Julia","Leah","Aubrey","Jasmine","Audrey","Katherine","Morgan","Brooklyn","Destiny","Sydney","Alexa","Kylie","Brooke","Kaitlyn","Evelyn","Layla","Madeline","Kimberly","Zoe","Jessica","Peyton","Alexandra","Claire","Madelyn","Maria","Mackenzie","Arianna","Jocelyn","Amelia","Angelina","Trinity","Andrea","Maya","Valeria","Sophie","Rachel","Vanessa","Aaliyah","Mariah","Gabrielle","Katelyn","Ariana","Bailey","Camila","Jennifer","Melanie","Gianna","Charlotte","Paige","Autumn","Payton","Faith","Sara","Isabelle","Caroline","Genesis","Isabel","Mary","Zoey","Gracie","Megan","Haley","Mya","Michelle","Molly","Stephanie","Nicole","Jenna","Natalia","Sadie","Jada","Serenity","Lucy","Ruby","Eva","Kennedy","Rylee","Jayla","Naomi","Rebecca","Lydia","Daniela","Bella","Keira","Adriana","Lilly","Hayden","Miley","Katie","Jade","Jordan","Gabriela","Amy","Angela","Melissa","Valerie","Giselle","Diana","Amanda","Kate","Laila","Reagan","Jordyn","Kylee","Danielle","Briana","Marley","Leslie","Kendall","Catherine","Liliana","Mckenzie","Jacqueline","Ashlyn","Reese","Marissa","London","Juliana","Shelby","Cheyenne","Angel","Daisy","Makenzie","Miranda","Erin","Amber","Alana","Ellie","Breanna","Ana","Mikayla","Summer","Piper","Adrianna","Jillian","Sierra","Jayden","Sienna","Alicia","Lila","Margaret","Alivia","Brooklynn","Karen","Violet","Sabrina","Stella","Aniyah","Annabelle","Alexandria","Kathryn","Skylar","Aliyah","Delilah","Julianna","Kelsey","Khloe","Carly","Amaya","Mariana","Christina","Alondra","Tessa","Eliana","Bianca","Jazmin","Clara","Vivian","Josephine","Delaney","Scarlett","Elena","Cadence","Alexia","Maggie","Laura","Nora","Ariel","Elise","Nadia","Mckenna","Chelsea","Lyla","Alaina","Jasmin","Hope","Leila","Caitlyn","Cassidy","Makenna","Allie","Izabella","Eden","Callie","Haylee","Caitlin","Kendra","Karina","Kyra","Kayleigh","Addyson","Kiara","Jazmine","Karla","Camryn","Alina","Lola","Kyla","Kelly","Fatima","Tiffany","Kira","Crystal","Mallory","Esmeralda","Alejandra","Eleanor","Angelica","Jayda","Abby","Kara","Veronica","Carmen","Jamie","Ryleigh","Valentina","Allyson","Dakota","Kamryn","Courtney","Cecilia","Madeleine","Aniya","Alison","Esther","Heaven","Aubree","Lindsey","Leilani","Nina","Melody","Macy","Ashlynn","Joanna","Cassandra","Alayna","Kaydence","Madilyn","Aurora","Heidi","Emerson","Kimora","Madalyn","Erica","Josie","Katelynn","Guadalupe","Harper","Ivy","Lexi","Camille","Savanna","Dulce","Daniella","Lucia","Emely","Joselyn","Kiley","Kailey","Miriam","Cynthia","Rihanna","Georgia","Rylie","Harmony","Kiera","Kyleigh","Monica","Bethany","Kaylie","Cameron","Teagan","Cora","Brynn","Ciara","Genevieve","Alice","Maddison","Eliza","Tatiana","Jaelyn","Erika","Ximena","April","Marely","Julie","Danica","Presley","Brielle","Julissa","Angie","Iris","Brenda","Hazel","Rose","Malia","Shayla","Fiona","Phoebe","Nayeli","Paola","Kaelyn","Selena","Audrina","Rebekah","Carolina","Janiyah","Michaela","Penelope","Janiya","Anastasia","Adeline","Ruth","Sasha","Denise","Holly","Madisyn","Hanna","Tatum","Marlee","Nataly","Helen","Janelle","Lizbeth","Serena","Anya","Jaslene","Kaylin","Jazlyn","Nancy","Lindsay","Desiree","Hayley","Itzel","Imani","Madelynn","Asia","Kadence","Madyson","Talia","Jane","Kayden","Annie","Amari","Bridget","Raegan","Jadyn","Celeste","Jimena","Luna","Yasmin","Emilia","Annika","Estrella","Sarai","Lacey","Ayla","Alessandra","Willow","Nyla","Dayana","Lilah","Lilliana","Natasha","Hadley","Harley","Priscilla","Claudia","Allisson","Baylee","Brenna","Brittany","Skyler","Fernanda","Danna","Melany","Cali","Lia","Macie","Lyric","Logan","Gloria","Lana","Mylee","Cindy","Lilian","Amira","Anahi","Alissa","Anaya","Lena","Ainsley","Sandra","Noelle","Marisol","Meredith","Kailyn","Lesly","Johanna","Diamond","Evangeline","Juliet","Kathleen","Meghan","Paisley","Athena","Hailee","Rosa","Wendy","Emilee","Sage","Alanna","Elaina","Cara","Nia","Paris","Casey","Dana","Emery","Rowan","Aubrie","Kaitlin","Jaden","Kenzie","Kiana","Viviana","Norah","Lauryn","Perla","Amiyah","Alyson","Rachael","Shannon","Aileen","Miracle","Lillie","Danika","Heather","Kassidy","Taryn","Tori","Francesca","Kristen","Amya","Elle","Kristina","Cheyanne","Haylie","Patricia","Anne","Samara","Skye","Kali","America","Lexie","Parker","Halle","Londyn","Abbigail","Linda","Hallie","Saniya","Bryanna","Bailee","Jaylynn","Mckayla","Quinn","Jaelynn","Jaida","Caylee","Jaiden","Melina","Abril","Sidney","Kassandra","Elisabeth","Adalyn","Kaylynn","Mercedes","Yesenia","Elliana","Brylee","Dylan","Isabela","Ryan","Ashlee","Daphne","Kenya","Marina","Christine","Mikaela","Kaitlynn","Justice","Saniyah","Jaliyah","Ingrid","Marie","Natalee","Joy","Juliette","Simone","Adelaide","Krystal","Kennedi","Mila","Tamia","Addisyn","Aylin","Dayanara","Sylvia","Clarissa","Maritza","Virginia","Braelyn","Jolie","Jaidyn","Kinsley","Kirsten","Laney","Marilyn","Whitney","Janessa","Raquel","Anika","Kamila","Aria","Rubi","Adelyn","Amara","Ayanna","Teresa","Zariah","Kaleigh","Amani","Carla","Yareli","Gwendolyn","Paulina","Nathalie","Annabella","Jaylin","Tabitha","Deanna","Madalynn","Journey","Aiyana","Skyla","Yaretzi","Ada","Liana","Karlee","Jenny","Myla","Cristina","Myah","Lisa","Tania","Isis","Jayleen","Jordin","Arely","Azul","Helena","Aryanna","Jaqueline","Lucille","Destinee","Martha","Zoie","Arielle","Liberty","Marlene","Elisa","Isla","Noemi","Raven","Jessie","Aleah","Kailee","Kaliyah","Lilyana","Haven","Tara","Giana","Camilla","Maliyah","Irene","Carley","Maeve","Lea","Macey","Sharon","Alisha","Marisa","Jaylene","Kaya","Scarlet","Siena","Adyson","Maia","Shiloh","Tiana","Jaycee","Gisselle","Yazmin","Eve","Shyanne","Arabella","Sherlyn","Sariah","Amiya","Kiersten","Madilynn","Shania","Aleena","Finley","Kinley","Kaia","Aliya","Taliyah","Pamela","Yoselin","Ellen","Carlie","Monserrat","Jakayla","Reyna","Yaritza","Carolyn","Clare","Lorelei","Paula","Zaria","Gracelyn","Kasey","Regan","Alena","Angelique","Regina","Britney","Emilie","Mariam","Jaylee","Julianne","Greta","Elyse","Lainey","Kallie","Felicity","Zion","Aspen","Carlee","Annalise","Iliana","Larissa","Akira","Sonia","Catalina","Phoenix","Joslyn","Anabelle","Mollie","Susan","Judith","Destiney","Hillary","Janet","Katrina","Mareli","Ansley","Kaylyn","Alexus","Gia","Maci","Elsa","Stacy","Kaylen","Carissa","Haleigh","Lorena","Jazlynn","Milagros","Luz","Leanna","Renee","Shaniya","Charlie","Abbie","Cailyn","Cherish","Elsie","Jazmyn","Elaine","Emmalee","Luciana","Dahlia","Jamya","Belinda","Mariyah","Chaya","Dayami","Rhianna","Yadira","Aryana","Rosemary","Armani","Cecelia","Celia","Barbara","Cristal","Eileen","Rayna","Campbell","Amina","Aisha","Amirah","Ally","Araceli","Averie","Mayra","Sanaa","Patience","Leyla","Selah","Zara","Chanel","Kaiya","Keyla","Miah","Aimee","Giovanna","Amelie","Kelsie","Alisson","Angeline","Dominique","Adrienne","Brisa","Cierra","Paloma","Isabell","Precious","Alma","Charity","Jacquelyn","Janae","Frances","Shyla","Janiah","Kierra","Karlie","Annabel","Jacey","Karissa","Jaylah","Xiomara","Edith","Marianna","Damaris","Deborah","Jaylyn","Evelin","Mara","Olive","Ayana","India","Kendal","Kayley","Tamara","Briley","Charlee","Nylah","Abbey","Moriah","Saige","Savanah","Giada","Hana","Lizeth","Matilda","Ann","Jazlene","Gillian","Beatrice","Ireland","Karly","Mylie","Yasmine","Ashly","Kenna","Maleah","Corinne","Keely","Tanya","Tianna","Adalynn","Ryann","Salma","Areli","Karma","Shyann","Kaley","Theresa","Evie","Gina","Roselyn","Kaila","Jaylen","Natalya","Meadow","Rayne","Aliza","Yuliana","June","Lilianna","Nathaly","Ali","Alisa","Aracely","Belen","Tess","Jocelynn","Litzy","Makena","Abagail","Giuliana","Joyce","Libby","Lillianna","Thalia","Tia","Sarahi","Zaniyah","Kristin","Lorelai","Mattie","Taniya","Jaslyn","Gemma","Valery","Lailah","Mckinley","Micah","Deja","Frida","Brynlee","Jewel","Krista","Mira","Yamilet","Adison","Carina","Karli","Magdalena","Stephany","Charlize","Raelynn","Aliana","Cassie","Mina","Karley","Shirley","Marlie","Alani","Taniyah","Cloe","Sanai","Lina","Nola","Anabella","Dalia","Raina","Mariela","Ariella","Bria","Kamari","Monique","Ashleigh","Reina","Alia","Ashanti","Lara","Lilia","Justine","Leia","Maribel","Abigayle","Tiara","Alannah","Princess","Sydnee","Kamora","Paityn","Payten","Naima","Gretchen","Heidy","Nyasia","Livia","Marin","Shaylee","Maryjane","Laci","Nathalia","Azaria","Anabel","Chasity","Emmy","Izabelle","Denisse","Emelia","Mireya","Shea","Amiah","Dixie","Maren","Averi","Esperanza","Micaela","Selina","Alyvia","Chana","Avah","Donna","Kaylah","Ashtyn","Karsyn","Makaila","Shayna","Essence","Leticia","Miya","Rory","Desirae","Kianna","Laurel","Neveah","Amaris","Hadassah","Dania","Hailie","Jamiya","Kathy","Laylah","Riya","Diya","Carleigh","Iyana","Kenley","Sloane","Elianna"]

const pingFreqSec=30
const connTimeout=5
const timeoutSec=10
const chatWriteSec=3

const baseP2P={
	lastPeerId: null,
	peer: null,
	conn: null,
	connected: false,
	recvIdInput: null,
	//recvId: null,
	userName: null,
	lobbyStatus: null,
	connList: [],
	master: false,
}

var p2p=null

resetP2P()

function resetP2P(){
	p2p=JSON.parse(JSON.stringify(baseP2P))
	
	p2p.recvIdInput = document.getElementById("idLobby")
	p2p.userName = document.getElementById("userName")?document.getElementById("userName").value:null
	p2p.lobbyStatus = document.getElementById("lobbyStatus")
	
	if(document.getElementById("kickUserControls")){
		document.getElementById("kickUserControls").style.display="none"
	}
	if(document.getElementById("secretRollShow")){
		document.getElementById("secretRollShow").style.display="none"
	}
}

function initP2P(callback){
	if(document.getElementById("userName").value.trim()==""){
		document.getElementById("userName").value=randomNames[randomInt(randomNames.length)]
	}
	
	resetP2P()
	
	setupPeer(callback)
}

function updateStatusConnection(stat){
	p2p.lobbyStatus.innerHTML=stat
	addChatLine("ConnectionManager", stat)
}

function setupPeer(callback=null){
	// Create own peer object with connection to shared PeerJS server
	p2p.peer = new Peer(null, {
		debug: 2
	});
	p2p.peer.on('open', function (id) {
		// Workaround for peer.reconnect deleting previous id
		if (p2p.peer.id === null) {
			console.log('Ricevuto id null da peer open');
			p2p.peer.id = p2p.lastPeerId;
		} else {
			p2p.lastPeerId = p2p.peer.id;
		}
		
		//setup peer events
		p2p.peer.on('connection', function (c) {
			//p2p.conn = c;
			console.log("Ricevuta connessione da: " + c.peer)
			
			setupP2PFunctions(c)
			p2p.connList.push(c)
			disableLobbySelector()
			shareClocks()
		});
		p2p.peer.on('disconnected', function () {
			if(!p2p.master){
				updateStatusConnection("Disconnesso");
				console.log('Disconnesso');
			} else {
				updateStatusConnection("Lobby chiusa");
				console.log('Lobby chiusa');
			}
			exitLobby()
		});
		p2p.peer.on('close', function() {
			if(!p2p.master){
				clockList=[]
			}
			
			resetP2P()
			console.log('Connessione peer interrotta');
			
			updateClocks()
			disableLobbySelector()
		});
		p2p.peer.on('error', function (err) {
			updateStatusConnection(err);
			console.log(err);
			try{
				p2p.peer.reconnect()
			} catch(e){
				updateStatusConnection(e);
				closeLobby()
				disableLobbySelector()
			}
		});

		console.log('ID: ' + p2p.peer.id);
		
		if(callback){
			callback()
		}
		disableLobbySelector()
		startPinger()
		shareClocks()
	});
}

function initializeLobby() {
	initP2P(
		function(){
			setupP2PFunctions()
			p2p.master=true
			if(document.getElementById("lobbyName").value.trim()==""){
				document.getElementById("lobbyName").value=randomNames[randomInt(lobbyNames.length)]
			}
			p2p.userName="GM"
			p2p.peer.lobbyName=document.getElementById("lobbyName").value
			document.getElementById("lobbyID").innerHTML="ID Lobby: " + p2p.peer.id
			updateStatusConnection("Aperta lobby <b>"+p2p.peer.lobbyName+"</b>")
			document.getElementById("endLobby").disabled=false
			document.getElementById("lobby").style.removeProperty("display")
			document.getElementById("kickUserControls").style.removeProperty("display")
			document.getElementById("secretRollShow").style.removeProperty("display")
			disableLobbySelector()
			broadcastUserList()
		}
	)
};

function shareLobby(){
	if(p2p.master){
		if(typeof Capacitor !== 'undefined') {
			if(typeof Capacitor.Plugins.Share !== 'undefined') {
				Capacitor.Plugins.Share.share(
					{
						text: "Connettiti a questa lobby di Fabula Ultima:",
						url: domain+p2p.peer.id,
					}
				)
				return
			}
		}
		

		let shareBtn = document.getElementById("shareLobby");
		shareBtn.setAttribute("lobbyID", p2p.peer.id)
		navigator.clipboard.writeText(shareBtn.getAttribute("lobbyID")).then(() => {
			alert("Lobby ID copiato: " + shareBtn.getAttribute("lobbyID"));
			return p2p.peer.id
		})

		/*navigator.clipboard.writeText(p2p.peer.id).then(() => {
			alert("Lobby ID copiato: " + p2p.peer.id);
			return p2p.peer.id
		})*/
	}
}

function closeLobby(){
	document.getElementById("lobbyID").innerHTML=""
	document.getElementById("lobby").style.display="none"
	p2p.peer.destroy()
}

async function joinLobby() {
	// Close old connection
	if (p2p.conn) {
		exitLobby()
	}
	
	if(document.getElementById("idLobby").value.trim()==""){
		alert("Inserire un ID lobby.")
		return false
	}
	
	initP2P(function() {
        setupP2PFunctions();
        startPinger(); // Start pinging even for non-master peers
    });
    
    checkForConnectionTimeout();
};

function exitLobby() {
	if (p2p.conn) {
		p2p.conn.close()
	}
	if (p2p.peer) {
		p2p.peer.destroy()
	}
	document.getElementById("userList").innerHTML=""
	document.getElementById("endLobby").disabled=true
	document.getElementById("clockMenu").style.removeProperty("display")
	updateClocks()
};
	
function setupP2PFunctions(newConn=null){
	let c=null
	
	if(newConn!=null){
		c=newConn
	} else {
		if(p2p.conn==null){
			p2p.conn = p2p.peer.connect(p2p.recvIdInput.value, {
				reliable: true
			})
		}
		c=p2p.conn
	}

	c.on('open', function () {
		p2p.connected=true
		if(!p2p.master){
			updateStatusConnection("Connesso a lobby.");
			alert("Connessione riuscita!")
			disableLobbySelector()
			p2p.connList.push(c)
			document.getElementById("clockMenu").style.display="none"
		}
		
		console.log("Connesso a: " + c.peer)
		
		c.on('data', function (data) {
			processPackage(data)
		});
		c.on('close', function () {
			p2p.connected=false
			p2p.connList.splice(p2p.connList.indexOf(c), 1)
			
			let notification=""
			
			if(!p2p.master){
				notification="La lobby è stata chiusa"
				disableLobbySelector()
				exitLobby()
			} else {
				notification="<span style='color:"+c.color+"'>"+c.userName+"</span> ha lasciato la lobby"
				broadcastUserList()
				broadcastMessage(notification, "Info");
			}
			
			updateStatusConnection(notification);
			console.log(notification);
		});
		
		sendData(
			{
				type: "user",
				user: p2p.userName,
				id: p2p.peer.id
			}
		);
	});
	
	updateStatusConnection("Connessione in corso...");
}

function forwardP2PMsg(msg, sender, conn=null) {
	sendData(
		{
			type: "chat",
			name: sender,
			data: msg
		},
		conn
	)
	//console.log("Mandato: " + msg);
}

//manda i dati in una specifica connessione
function sendData(data, toConn=null){
	console.log("Mandato pacchetto")
	console.log(data)
	
	let c=toConn
	
	if(c ==null){
		c=p2p.conn
	}
	
	if (c/* && c.open*/) {
		c.send(data);
	} else {
		console.log('La connessione non è istanziata');
	}
}

//manda i dati a tutte le connessioni
function broadcastMessage(msg, sender=null){
	let who=sender
	
	if(who==null){
		who="GM"
	}
	
	if(p2p.peer != null){
		if(p2p.master){
			if(!document.getElementById("secretRoll").checked){
				for(let i=0;i<p2p.connList.length;i++){
					forwardP2PMsg(msg, who, p2p.connList[i])
				}
			}
			addChatLine(who, msg)
		} else {
			//forwardP2PMsg(msg)
			sendData(
				{
					type: "broadcast",
					id: p2p.peer.id,
					data: msg
				}
			)
			console.log("Mandato in broadcast: " + msg);
		}
	} else {
		addChatLine(who, msg)
	}
}

//condivide la lista di utenti connessa alla lobby
function broadcastUserList(){
	if(p2p.peer != null){
		let userList=
			{
				names: ["GM"],
				peer: [""],
			}
		
		for(let x=0;x<p2p.connList.length;x++){
			userList.names.push(p2p.connList[x].userName)
			userList.peer.push(p2p.connList[x].peer)
		}
		
		if(p2p.master){
			for(let i=0;i<p2p.connList.length;i++){
				sendData(
					{
						type: "userlist",
						//data: JSON.stringify(userList)
						data: userList
					},
					p2p.connList[i]
				)
			}
		}
		showUserList(userList)
		console.log("Mandata in broadcast la lista utenti");
	}
}

//funzione per mostrare la lista utenti
function showUserList(list){
	document.getElementById("userList").innerHTML="Attualmente connessi: "+list.names.join(', ')
	
	document.getElementById("usListChar").innerHTML=""
	document.getElementById("usListLib").innerHTML=""
	document.getElementById("usListKick").innerHTML=""
	
	let userOpt=document.createElement("option")
	
	for(let i=0;i<list.names.length;i++){
		let ch=userOpt.cloneNode()
		let li=userOpt.cloneNode()
		
		ch.innerHTML=list.names[i]
		li.innerHTML=list.names[i]
		ch.value=list.peer[i]
		li.value=list.peer[i]
		
		document.getElementById("usListChar").appendChild(ch)
		document.getElementById("usListLib").appendChild(li)
		
		if(p2p.connList.filter(c=>c.peer===list.peer[i]).length>0 && p2p.master){
			let us=userOpt.cloneNode()
			us.innerHTML=list.names[i]
			us.value=list.peer[i]
			document.getElementById("usListKick").appendChild(us)
		}
	}
}

//condivide la libreria a tutte le connessioni
function broadcastLibrary(libJSON){
	if(p2p.peer != null){
		if(p2p.master){
			for(let i=0;i<p2p.connList.length;i++){
				shareLibrary(libJSON, p2p.connList[i])
			}
		} else {
			shareLibrary(libJSON)
		}
		console.log("Mandata in broadcast la libreria selezionata");
	}
}

//funzione per mandare a tutti i giocatori, da GM, una libreria
function shareLibrary(libJSON, toConn=null, peer=null){
	if(p2p.master){
		if(peer==null){
			for(let i=0;i<p2p.connList.length;i++){
				sendData(
					{
						type: "share",
						what: "library",
						data: libJSON,
						toWho: peer!=null?peer:null
					}, 
					p2p.connList[i]
				)
			}
		} else {
			sendData(
				{
					type: "share",
					what: "library",
					data: libJSON,
					toWho: peer!=null?peer:null
				}, 
				p2p.connList.filter(c=>c.peer===peer)[0]
			)
		}
	} else {
		sendData(
			{
				type: "share",
				what: "library",
				data: libJSON,
				toWho: peer!=null?peer:null
			}
		)
	}
}

//funzione per condividere lo schema personaggio col GM
function shareCharacter(charJSON, peer=null){
	if(p2p.master){
		//for(let i=0;i<p2p.connList.length;i++){
			sendData(
				{
					type: "share",
					what: "character",
					data: charJSON,
					toWho: peer,
				}, 
				//p2p.connList[i]
				p2p.connList.filter(c=>c.peer===peer)[0]
			)
		//}
	} else {
		sendData(
			{
				type: "share",
				what: "character",
				data: charJSON,
				toWho: peer,
			}
		)
	}
	console.log("Condiviso il personaggio selezionato");
}

//condivide gli orologi del GM
function shareClocks(){
	if(p2p.peer){
		if(p2p.master){
			for(let i=0;i<p2p.connList.length;i++){
				sendData(
					{
						type: "clocks",
						data: getClockParamList()
					}, 
					p2p.connList[i]
				)
			}
		}
		console.log("Condivisi gli orologi attivi");
	}
}

//restituisce il nome utente settato all'avvio della connessione
function userLookup(id){
	let refConn=p2p.connList.length>0?p2p.connList.filter(c=>c.peer==id)[0]:null
	
	let res={
		name: refConn!=null?refConn.userName:"Nessuno",
		color: refConn!=null?refConn.color:"Nessuno",
	}
	
	return res
}

function processPackage(pack){
	//console.log(pack)
	
	if(pack.hasOwnProperty("type")){
		packProcessing(pack)
	}
}

function packProcessing(pack){
	console.log("Ricevuto pacchetto")
	console.log(pack)
	
	let packProcessing={
		"chat": function(){
			addChatLine(pack.name, pack.data)
		},
		"user": function(){
			let user=null
			if(p2p.connList.length>0){
				user=p2p.connList.filter(c=>c.peer==pack.id)[0]
				user.userName=sanitizeString(pack.user)
				user.color="rgb("+randomInt(256)+","+randomInt(256)+","+randomInt(256)+")"
			}
			updateStatusConnection("<span style='color:"+user.color+"'>"+user.userName+"</span> si è connesso!");
			sendData(
			{
				type: "conn",
				data: p2p.peer.lobbyName
			},
			user)
			broadcastMessage("<span style='color:"+user.color+"'>"+sanitizeString(user.userName)+"</span> si è connesso!", "Info");
			broadcastUserList()
			shareClocks()
		},
		"userlist": function(){
			showUserList(pack.data)
		},
		"broadcast": function(){
			let user=userLookup(pack.id)
			broadcastMessage(pack.data, "<span style='color:"+user.color+"'>"+sanitizeString(user.name)+"</span>")
		},
		"conn": function(){
			addChatLine("Info", "Connesso a lobby "+sanitizeString(pack.data))
		},
		"clocks": function(){
			document.getElementById("clockList").innerHTML=""
			clockList=[]
			
			for(let i=0;i<pack.data.length;i++){
				let newClock=createNewClock(
					pack.data[i]
				)
				clockList.push(newClock)
			}
			updateClocks()
		},
		"share": function(){
			if(pack.toWho==p2p.peer.id || pack.toWho=="" || pack.toWho==null){
				let sanData=JSON.parse(sanitizeString(pack.data))
				
				if(pack.what=="character"){
					if(window.confirm("Ricevuti i dati di una scheda personaggio: caricare in memoria?")){
						loadCharacter(sanData);
						saveCharacter()
					}
				} else if(pack.what=="library"){
					if(window.confirm("Ricevuti i dati di una libreria: caricare in memoria?")){
						loadLibrary(sanData);
						setLibraryToBeSaved(true);
						saveLibraryPrompt();
					}
				}
			} else {
				sendData(
					{
						type: "share",
						what: pack.what,
						data: pack.data,
						toWho: pack.toWho,
					}, 
					p2p.connList.filter(c=>c.peer===pack.toWho)[0]
				)
			}
		},
		"ping": function(){
			answerPing(pack.whoPings)
		},
		"aliveCheck": function(){
			console.log(pack.peer + " is alive.")
			p2p.connList.filter(c=>c.peer===pack.peer)[0].checked=true
		},
		"whoWrites": function(){
			let p=p2p.connList.filter(c=>c.peer===pack.peer)[0]
			console.log(pack.peer + " is writing.")
			setWritingTimeout(p)
		},
		"updateWriters": function(){
			document.getElementById("chatFeedback").innerHTML=pack.data
		},
		"ping": function() {
			answerPing(pack.whoPings, pack.timestamp);
		},
		"pong": function() {
			handlePong(pack);
		},
	}
	
	packProcessing[pack.type]()
}

function setWritingTimeout(p){
	if(p.isWriting==null || typeof p.isWriting==undefined){
		p.isWriting=Date.now()
		updateWriters(whoIsWriting())
		
		const checkLater = async ()=>{
			await sleep(1000*chatWriteSec)
			
			if(p.isWriting+1000*chatWriteSec<Date.now()){
				p.isWriting=null
				updateWriters(whoIsWriting())
			} else {
				p.isWriting=Date.now()
				checkLater()
			}
		}
		
		checkLater()
	}
}

async function checkForConnectionTimeout(){
	await sleep(1000*connTimeout)
	if(!p2p.connected){
		closeLobby()
		updateStatusConnection("Timeout connessione.");
		disableLobbySelector()
		return false
	}
}

function signalWriting(whoPings=null){
	if(p2p.peer){
		if(!p2p.master){
			sendData(
				{
					type: "whoWrites",
					peer: p2p.peer.id
				},
				p2p.connList.filter(c=>c.peer===whoPings)[0]
			)
		} else {
			setWritingTimeout(p2p.peer)
		}
	}
}

function updateWriters(list){
	const maxNames=3
	let str=""
	let closer=" sta scrivendo..."
	let num=list.length
	
	if(p2p.master && p2p.peer.isWriting>0 && !document.getElementById("secretRoll").checked){
		num++
		str+="GM"
	} 
	
	if(num==0){
		document.getElementById("chatFeedback").innerHTML=""
		forwardWritersList(str)
		return ""
	} else if(num>maxNames){
		closer=" e altri stanno scrivendo"
		num=maxNames
	} else if(num>1) {
		closer=" stanno scrivendo"
	}
	
	for(let i=0;i<list.length;i++){
		if(str!=""){
			str+=", "
		}
		
		str+=list[i].userName
	}
	
	str+=closer
	
	document.getElementById("chatFeedback").innerHTML=str
	forwardWritersList(str)
	return str
}

function forwardWritersList(str){
	//broadcast agli altri peer
	if(p2p.peer != null){
		if(p2p.master){
			for(let i=0;i<p2p.connList.length;i++){
				sendData(
					{
						type: "updateWriters",
						data: str
					},
					p2p.connList[i]
				)
			}
		}
	}
}

function whoIsWriting(){
	return p2p.connList.filter(c=>c.isWriting>0)
}

//tiene la connessione attiva e controlla connessioni cadute
async function startPinger(ongoing = true) {
    if (p2p.peer != null) {
        let connections = p2p.master ? p2p.connList : [p2p.conn];
        
        for (let i = 0; i < connections.length; i++) {
            connections[i].checked = false;
            sendData(
                {
                    type: "ping",
                    whoPings: p2p.peer.id,
                    timestamp: Date.now()
                },
                connections[i]
            );
            waitForAnswer(connections[i]);
        }

        if (ongoing) {
            await sleep(1000 * pingFreqSec);
            startPinger();
        }
    }
}

async function waitForAnswer(conn){
	await sleep(1000*timeoutSec)
	
	if(!conn.checked){
		console.log(conn.userName+" non risponde...");
		//broadcastMessage(conn.userName+" non risponde...", "Info");
		//conn.close()
	}
}

function kickUser(connId){
	p2p.connList.filter(c=>c.peer===connId)[0].close()
}

function answerPing(whoPings, timestamp) {
    let responseConn = p2p.master ? 
        p2p.connList.filter(c => c.peer === whoPings)[0] : 
        p2p.conn;

    sendData(
        {
            type: "pong",
            respondingPeer: p2p.peer.id,
            originalTimestamp: timestamp
        },
        responseConn
    );
}

function handlePong(data) {
    let conn = p2p.master ? 
        p2p.connList.filter(c => c.peer === data.respondingPeer)[0] : 
        p2p.conn;

    if (conn) {
        conn.checked = true;
        conn.latency = Date.now() - data.originalTimestamp;
        console.log(`Latency to ${conn.peer}: ${conn.latency}ms`);
    }
}

function attemptReconnection() {
	if (!p2p.connected && p2p.peer) {
	  console.log("Attempting to reconnect...");
	  p2p.peer.reconnect();
	  setTimeout(attemptReconnection, 5000); // Try again in 5 seconds if still not connected
	}
  }
  
  p2p.peer.on('disconnected', function () {
	console.log('Disconnected from server or peer.');
	attemptReconnection();
  });

  p2p.peer.on('close', function() {
	console.log('Connection closed. Cleaning up.');
	p2p.connected = false;
	// Perform cleanup here
  });

  p2p.peer.on('error', function (err) {
	console.error('PeerJS error:', err);
	updateStatusConnection("Connection error: " + err.type);
	
	if (err.type === 'network' || err.type === 'disconnected') {
	  attemptReconnection();
	} else if (err.type === 'server-error') {
	  // Maybe try a different server or inform the user
	} else {
	  // Handle other types of errors
	}
  });

//whisper verso uno specifico peer
//salvare log chat?
//salvare nome utente?